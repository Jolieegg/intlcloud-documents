## 구성 시나리오

악의적인 사용자의 핫링크로 인한 높은 대역폭이나 트래픽 사용량으로 인해 높은 요금이 발생하는 것이 우려되는 경우 사용량 제한 기능을 사용하여 사용량을 제어할 수 있습니다.

통계 주기 동안 대역폭 또는 트래픽 사용량이 구성된 알람 임계값을 초과하면 CDN이 메시지 알림을 푸시합니다. 대역폭 한도를 초과하면 CDN을 비활성화하여 더 많은 CDN 서비스 요금이 발생하지 않도록 할 수 있습니다.

> !사용량 제한 설정이 적용되는 데는 약 10분이 소요되며, 그 동안에는 정상적으로 사용 요금이 청구됩니다. 자세한 내용은 [공격 리스크 예방 솔루션](https://intl.cloud.tencent.com/document/product/228/42355)을 참고하십시오.

## 구성 가이드

### 구성 보기

[CDN 콘솔](https://console.cloud.tencent.com/cdn)에 로그인하여 왼쪽 사이드바에서 **도메인 관리**를 선택한 후 도메인 이름 오른쪽의 **관리**를 클릭하여 구성 페이지로 이동합니다. **고급 구성** 탭에서 사용량 제한 구성을 찾을 수 있으며 기본적으로 비활성화되어 있습니다.
<img src="https://qcloudimg.tencent-cloud.cn/raw/2ddc0a57e196e3e1136b954ed46a88db.png" width="70%">

### 세부 구성 항목

#### 1. 구성 활성화

스위치를 켜고 항목을 구성합니다.
<img src="https://qcloudimg.tencent-cloud.cn/raw/3806b3b7ea8cdf3f269536fd5fc22c16.png" width="60%">


- 통계 유형:
  - 순간 사용량 : 5분마다 1회 트래픽/대역폭 사용량에 대한 통계를 수집합니다.
  - 누적 사용량 : 순간 사용량에 비해 더 긴 통계 주기(매시간 또는 달력일)을 지원합니다.

> !동적 콘텐츠 또는 동적 및 정적 콘텐츠의 가속 유형이 있는 도메인 이름에 대해서는 「누적 사용량」 제한 설정이 지원되지 않습니다.

- 통계 주기 : 5분 단위, 1시간 단위, 1일 단위(당일 24시 이전)

> !
> - 통계 주기는 구성 시간 5분 전부터 시작됩니다.
>   예를 들어 09:05:01 - 09:09:59에 규칙을 설정한 경우 통계 주기는 09:05:00부터 시작됩니다.
> - 통계 주기으로 ‘1시간 단위’를 선택한 경우 (1) 첫 번째 통계 주기는 1시간 미만입니다. (2) 다음 통계 주기부터 사용량 통계 정보를 매 시간 1회씩 수집합니다.
>   예를 들어 규칙이 2022-01-13 9:23:10에 구성된 경우 첫 번째 통계 주기는 9:20:00 – 9:59:59이고 다음 통계 주기는 10:00:00 – 10:59:59입니다.
> - 통계 주기로 ‘당일 24시 이전’을 선택한 경우, 통계 주기는 2022-01-13 9:20:00 - 2022-01-13 23:59:59입니다.

- 상한: 순간 사용량은 트래픽/대역폭 옵션을 모두 지원하는 반면 누적 사용량은 트래픽만 지원합니다.
  - 트래픽: 도메인 이름의 트래픽 사용량에 대한 통계를 수집합니다. 트래픽 제한은 도메인 이름에 대한 사용자 액세스의 최대 트래픽입니다.
  - 대역폭: 도메인 이름의 대역폭 사용량에 대한 통계를 수집합니다. 최대 대역폭은 사용자가 도메인 이름에 액세스할 수 있는 최대 대역폭입니다.
- 차단 해제 기간: 예약 해제/차단 해제 안함이 지원됩니다.
  - 예약 해제: 60분, 12시간, 24시간 또는 3일.
    예를 들어, 도메인 이름 ex.com이 한도를 초과한 후 404(CDN 비활성화됨)를 반환하도록 설정되고 자동 차단 해제 기간이 60분으로 설정된 경우 구성된 누적 사용량 한도 초과 후 CDN과 가속 도메인 이름이 비활성화되고 60분 후에 자동으로 차단이 해제됩니다.
  - 차단 해제 안 함: 도메인 이름이 트래픽이 많거나 고대역폭 공격에 취약할 수 있다고 우려되는 경우 차단 해제 안 함을 설정할 수 있습니다. 제한을 초과한 후 도메인 이름이 404(CDN 비활성화됨)를 반환하도록 설정된 경우 구성된 누적 사용량 한도 초과 후 도메인 이름이 비활성화되며 필요한 경우 콘솔에서 도메인 이름 가속을 수동으로 활성화해야 합니다.
- 한도 초과 시:
  - 반환 404: 한도를 초과하면 도메인 이름에 대해 CDN이 바로 비활성화됩니다. 이 경우 도메인 관리 페이지로 이동하여 도메인 이름을 다시 활성화하여 CDN 서비스를 재개할 수 있습니다.
    **참고:** 원본 유형이 COS 원본/타사 객체 스토리지 원본인 경우 404(CDN 비활성화) 반환만 지원됩니다. 
- 알람 임계값:
  트래픽 상한에 대한 액세스 대역폭의 비율이 구성된 비율(10의 배수만 지원됨, 즉 10% - 90%)을 초과하면 CDN은 알람 메시지를 푸시합니다.

> !
> - 도메인 이름 대역폭(트래픽)의 임계값 초과가 감지되면 404 반환 구성이 전체 네트워크에서 노드별로 전달되어야 합니다. 따라서 구성이 적용되는 데 약간의 지연이 있습니다.
> - 알람 임계값이 활성화된 경우, 스캔 간격이 5min이므로 사용량이 급증하거나 구성된 백분율 값이 큰 경우, 알람 임계값이 이전 스캔 중에 트리거되지 않고 다음 스캔 중에 대역폭 한도에 직접 도달하는 경우가 발생할 수 있습니다. 이 경우 CDN은 백분율 및 대역폭 상한에 대한 알람을 순차적으로 전송합니다.

#### 2. 지역별 구성 추가

가속 도메인 이름이 글로벌 가속에 대해 구성되어 있고 중국 본토 내외에서 가속에 대해 다른 사용량 제한을 구성하려는 경우 **특수 구성 추가**를 클릭합니다.
![](https://qcloudimg.tencent-cloud.cn/raw/514910fe27000e0b742049d9d864632f.png)

> !
> - 현재 추가된 리전별 구성은 비활성화만 가능하고 삭제할 수는 없습니다.
> - 동적 콘텐츠 또는 동적 및 정적 콘텐츠의 가속 유형이 있는 도메인 이름에 대해서는 「리전별 구성」이 지원되지 않습니다.

#### 구성 예시

도메인 이름 `cloud.tencent.com`이 글로벌 가속을 위해 구성되고 리전별 사용량 제한 구성(중국 본토 외의 리전용)이 다음과 같이 추가된다고 가정합니다.
![](https://qcloudimg.tencent-cloud.cn/raw/3dcecb342ba6c4bc7b44d80be6028839.png)

- 중국 본토 내외 리전 구성의 상호 독립성: 리전별 구성으로 ‘중국 본토 외’를 선택하면 초기 구성이 중국 본토에서 적용됩니다. 중국 본토의 트래픽이 통계 주기(5분) 동안 4G에 도달하면 중국 본토 외부의 서비스에 영향을 주지 않고 중국 본토의 모든 요청에 대해 404 오류가 반환됩니다. 중국 본토 외부의 트래픽이 통계 주기(당일 24:00 이전) 동안 11G에 도달하면 중국 본토의 서비스에 영향을 주지 않고 중국 본토 외부의 모든 요청에 대해 404 오류가 반환됩니다.
- 가속 리전 전환: 도메인 이름의 가속 리전이 글로벌에서 중국 본토로 전환되는 경우 중국 본토 외부에 대한 사용량 제한 구성은 기본적으로 비활성화되며 수정할 수 없습니다.

#### 3. 구성 비활성화

사용량 제한 기능을 해제할 수 있습니다. 해제 시 기존 구성이 있어도 프로덕션 환경에서는 적용되지 않습니다. 스위치를 켜면 구성이 전체 네트워크에 적용되기 전에 이 기능을 활성화할지 묻는 메시지가 표시됩니다.

## 設定シナリオ

悪意のあるユーザーによる大量の帯域幅やトラフィックの盗難によって高額の請求が発生することを心配する場合は、使用量上限設定機能を使用して使用量を制限します。

統計周期内に発生した帯域幅またはトラフィックが設定されたアラートのしきい値を超えた場合、CDNがメッセージ通知を送信します。設定されたアクセスしきい値を超えた場合は、CDNサービスを停止して、それ以上のCDNサービス料金が発生しないようにします。

>! 使用量上限設定の有効化には遅延（約10分）があり、途中に発生した使用量は通常課金されます。詳細については、[攻撃リスク防止プラン](https://intl.cloud.tencent.com/document/product/228/42355)をご参照ください。

## 設定ガイド

### 設定の表示

[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、メニューバーから**ドメイン名管理**を選択し、ドメイン名の右側にある**管理**をクリックすると、ドメイン名設定ページに進み、**高度な設定**で使用量上限の設定を確認することができます。デフォルトでは無効になっていま：
<img src="https://qcloudimg.tencent-cloud.cn/raw/2ddc0a57e196e3e1136b954ed46a88db.png" width="70%">

### 詳細設定

#### 1. 有効にする

[設定スイッチオン]をクリックして、詳細の設定を行います：
<img src="https://qcloudimg.tencent-cloud.cn/raw/3806b3b7ea8cdf3f269536fd5fc22c16.png" width="60%">


- 統計タイプ：
  - 一時的な使用量：5分ごとにトラフィック/帯域幅の使用量を統計的に測定します。
  - 累積使用量：一時的な使用量よりも長い統計期間があり、時間単位/自然日単位のトラフィックの使用量統計をサポートします。

>! アクセラレーションタイプがECDN動的加速アクセラレーションおよびECDN動的アクセラレーションのドメイン名は、「累積使用量」の上限設定をサポートしていません。

- 統計サイクル：分（5分ごと）、時間（1時間ごと）、日（当日24時まで）の統計サイクルをサポートします。

> !
>- 統計サイクルの開始時刻は設定時間より前の5分刻みに切り捨てする時刻とします：
>   例：09:05:01から09:09:59までルールを設定する場合、09:05:00は統計サイクルの開始時刻です。
> - 統計サイクルが「1時間ごと」を選択した場合、（1）設定後の最初の1時間のデータ統計サイクルについて、1時間未満の統計時間になり、（2）次のデータ統計サイクルに入り、1時間ごとに使用量を統計します。
>   例：2022-01-13の9:23:10にルールを設定すると、最初のデータ統計サイクルは9:20:00～9:59:59、次回の統計サイクルは10:00:00~10:59:59となります。
> - 統計サイクルに「当日24時まで」を選択すると、統計サイクルは2022-01-13の9:20:00から2022-01-13の23:59:59までとなります。

- 上限設定：一時的な使用量の場合はトラフィック/帯域幅の上限設定をサポートし、累積使用量の場合は、トラフィックのみをサポートします。
  - トラフィック上限：統計するドメイン名のトラフィック消費量。トラフィックしきい値はユーザーがこのドメイン名にアクセスするためのトラフィックの上限値です。
  - 帯域幅上限：統計するドメイン名の帯域幅消費量。帯域幅のしきい値はユーザーがこのドメイン名にアクセスするための帯域幅の上限値です。
- 上限解除時間：定期的な解除/永久的な解除禁止をサポートします。
  - 定期的な解除：定期的な解除サイクルは、60分、12時間、24時間、3日間に対応しています。
    例えば、設定したex.comドメイン名がしきい値を超えた後にアクセスが404（CDNサービスオフ）を返します、自動解除時間が60分になります。ドメイン名が設定された累積使用量上限のしきい値を超えると、CDNサービスが停止し、アクセラレーションされたドメイン名がオフラインになります。60分後、ドメイン名を自動的に解除し、ドメイン名のアクセラレーションをオンにします。
  - 永久的な解除禁止：ドメイン名が大規模なトラフィック/帯域幅の攻撃を受けることを心配する場合は、永久的な解除禁止を設定することができます。設定値がしきい値を超えた場合、アクセスは404を返します（CDNサービスをオフにします）。ドメイン名が設定された累積使用量上限のしきい値を超えると、ドメイン名はオフラインになり、自分でコンソールに移動してドメイン名アクセラレーションをオンにする必要があります。
- 閾値を超えた場合：
  - アクセスが404を返します。しきい値を超えた場合、そのドメイン名のCDNサービスを直接オフにします。ドメイン名管理ページで再びドメイン名がオンラインになり、CDNサービスを回復するよう設定します。
    **注：**オリジンサーバーのタイプがCOSソース/サード・パーティのオブジェクトストアでは、アクセスの404返し（CDNサービスのオフ）のみがサポートされています。 
- アラームのしきい値：
  アクセス帯域幅/トラフィックしきい値の比が設定されたパーセンテージ（10%～90%のような10の倍数のみ入力可能）を超えた場合、CDNはアラームメッセージを送信します

> !
> - ドメイン名の帯域幅（トラフィック）がしきい値を超えたことを検出した後、アクセスが404エラーを返します。設定の有効化はネットワーク全体のノードが徐々に配信する必要があるため、有効になるまで遅延が発生する可能性があります。
> - アラームのしきい値がオンになっている場合：スキャンの時間単位が5分間であるため、使用量が短期間に急増したり、パーセンテージの設定値が大きくなったりすると、前回のスキャンでパーセンテージのアラームのしきい値がトリガーされず、次のスキャンでアクセスのしきい値に直接達した可能性があります。この場合は、CDNはパーセンテージアラームとアクセスしきい値アラームの2つの通知メッセージを送信します。

#### 2.地域の特別な設定

アクセラレーションドメイン名のサービスリージョンがグローバルアクセラレーションであり、中国国内と中国国外のアクセラレーションリージョンに異なる使用量の上限を設定する場合は、設定の下にある**特別な設定を追加**をクリックして設定できます：
![](https://qcloudimg.tencent-cloud.cn/raw/514910fe27000e0b742049d9d864632f.png)

> !
>- 地域の特別な設定が追加された後、削除することはできません。設定を無効にすることができます。
>- アクセラレーションタイプがECDN動的アクセラレーションおよびECDN動的アクセラレーションのドメイン名では「リージョンの特別設定」をサポートしません。

#### 設定例

アクセラレーションドメイン名`cloud.tencent.com`がグローバルアクセラレーションドメイン名である場合、新しいリージョンの特別設定（中国国外）の使用量の上限は以下の通りです：
![](https://qcloudimg.tencent-cloud.cn/raw/3dcecb342ba6c4bc7b44d80be6028839.png)

- 国内外の設定は相互に影響しません。リージョンの特別設定に「中国国外」を選択すると、初期設定は中国国内で有効になります。国内トラフィックが統計サイクル（5分）内に4GBに達した場合、すべての国内からのリクエストは404を返し、海外サービスに影響を与えません。海外トラフィックが統計サイクル（その日の24時まで）内に11GBに到達すると、すべての海外からのリクエストは404を返し、国内サービスに影響を与えません。
- ドメイン名のアクセラレーションリージョンの切り替え：グローバルアクセラレーションドメイン名を中国国内アクセラレーションドメイン名に切り替えた場合、使用量上限の海外設定はデフォルトでオフになり、編集できません。

#### 3. 設定を無効にする

使用量上限スイッチを切り替えて、この機能を無効にすることができます。スイッチがオフの場合、下位に既に設定が存在しても実稼働環境では有効になりません。再びスイッチをオンに切り替えると、ネットワーク全体で設定が有効になる前に、先に設定の2回目の確認が行われます。

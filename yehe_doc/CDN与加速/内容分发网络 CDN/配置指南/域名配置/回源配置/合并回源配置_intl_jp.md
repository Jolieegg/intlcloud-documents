
大規模ECセールイベントのような、大量なリソースを必要とし、膨大な並列リクエストが発生する運用シーンでは、Back-to-Originマージを有効にすれば、キャッシュヒット率を向上させ、Back-to-Originの負荷を減らすことができます。

## 機能説明
複数のユーザーがCDNノードにキャッシングされていない同一リソースを同時に要求すると、リクエストごとにBack-to-Originが発生し、Back-to-Origin帯域幅と接続数が急増します。オリジンサーバーで性能のボトルネックになっている場合、オリジンサーバーの応答が遅くなったり、応答しなかったりして、結果的にユーザビリティが低下する可能性があります。
Back-to-Originマージとは、ノードにキャッシングされていない同一リソースを要求した複数のリクエストが発行された場合、Back-to-Originを1回だけ実行し、他のユーザーにBack-to-Originリクエストの応答を待たせる処理です。この機能はオリジンサーバーの負荷を減らし、ユーザーアクセスのヒット率を向上させることができます。
下図に示すように、3つのユーザーが同時に同じノードに同一リソースを要求すると、マインリクエストに対してBack-to-Originを実行しリソースを取得し、他のサブリクエストが待ちキューに入ります。メインリクエストに対するオリジンサーバーの応答を受信すると、メインリクエストを発行したユーザーにデータを渡し、CDNノードにキャッシングします。同時に、待ちキューにあるすべてのサブリクエストに通知します。これらのサブリクエストはキャッシュからデータを読み取り、サブリクエストを発行したユーザーに応答します。
<img src="https://qcloudimg.tencent-cloud.cn/raw/e448eeed5a105cec5d2cb77cf646f5a7.png" width="80%">

## 注意事項
1. ステータスコードが200/206/304の応答だけに対して、Back-to-Originマージを実行します。
2. オリジンサーバーがcache-control: no-cache、no-store、privateまたはpragma：no-cacheなどを返し、指定したCDNノードにキャッシングできない場合、Back-to-Originマージを実行しません。
3. オリジンサーバーがchunkedを返した場合、Back-to-Originマージを実行しません。
4. GETリクエストの場合のみ、Back-to-Originマージを実行します。
5. オリジンサーバーが返したHTTP応答ヘッダーにcontent-lengthとtransfer-encodingのいずれも含まれていない場合、Back-to-Originマージを実行しません。
6. gzipやbrなどの圧縮リクエストの場合、Back-to-Originマージを実行しません。

## 設定説明
1.[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインします。
2. 左側のメニューでドメイン名管理をクリックし、ドメイン名管理リストへ進みます。
3. 設定するドメイン名を選択し、管理をクリックして、ドメイン名の設定ページへ進みます。
4. Back-to-Origin設定をクリックしBack-to-Origin設定タブに切り替えると、Back-to-Originマージの設定項目が表示されます。
![]()
5. Back-to-Originマージはデフォルトでは無効です。必要に応じて有効にしてください。

## 設定例
Back-to-Originマージを有効にします。
![]()





ファイルが静的な大容量ファイルで構成されている場合は、Back-to-Origin of Rangeを有効にすると、Back-to-Originファイルの応答性が向上し、大容量ファイルの配信効率が向上します。

## 機能の説明
Back-to-Origin of Rangeとは、RangeリクエストのBack-to-Originのことで、RangeはHTTPリクエストヘッダーの1つで、指定された範囲内のファイルを取得するために使用されます。Rangeリクエストを使用すると、サーバーにファイルの内容の一部をリクエストできます。例えば、リクエストにHTTPヘッダー「range：bytes=0～999」が含まれる場合、ファイルの最初の1000バイトがユーザーに返されます。
Tencent Cloud CDNでBack-to-Origin of Range設定を有効にすると、デフォルトでBack-to-Origin of Rangeリクエストが含まれます。ユーザーがリクエストしたファイルの一部がノードでキャッシュされていないか、またはキャッシュが期限切れになっている場合、CDNはユーザーのリクエストによりBack-to-Origin of Rangeを行い、ユーザーが必要とするファイルのみをプルしてキャッシュし、ユーザーに返します。Range back-to-origin設定を無効にすると、ユーザーのリクエストにRangeリクエストが含まれていない場合、CDNはback-to-originするときにファイル全体をプルします。
APKインストールパッケージ、オーディオビデオファイルなどの大容量ファイルタイプの場合は、rangeリクエストを使用することで、大容量ファイルの配信効率が効果的に向上し、応答時間が改善され、オリジンサーバーへの負荷が軽減されます。

## 注意事項
1. Back-to-Origin of Range設定を有効にするには、オリジンサーバーで Rangeリクエストがサポートされている必要があります。そうでない場合、Back-to-Originが失敗する可能性があります。
2. Back-to-Origin of Range設定を有効にすると、リソースはノードのシャードにキャッシュされますが、各シャードのキャッシュの有効期限が全部一致し、ユーザーが指定したキャッシュ有効期限ルールに従います。
3. リソースがすべて静的な小容量ファイルの場合、またはオリジンサーバーがCOSオリジンサーバーであり、かつデータ処理系の機能（画像処理など）をすでに使用している場合は、Back-to-Origin of Rangeを有効にするとback-to-originに影響が生じるおそれがあるため、お勧めしません。
4. リソースがすべて静的な大容量ファイルの場合で、なおかつオリジンサーバーがRangeリクエストをサポートしているか、またはオリジンサーバーがCOSオリジンサーバーであり、かつデータ処理系の機能（画像処理など）を使用していない場合は、配信効率と応答速度を向上させるためにBack-to-Origin of Rangeを有効にすることをお勧めします。

## 設定についての説明

### ドメイン名管理の設定
1. [CDNコンソール](https://console.cloud.tencent.com/cdn)にログインします。
2. 左側のメニューで**ドメイン名管理**をクリックし、ドメイン名管理リストへ進みます。
3. 設定するドメイン名を選択し、**管理**をクリックして、ドメイン名の設定ページへ進みます。
4. 「**Back-to-Origin設定**」をクリックして「Back-to-Origin設定」タブに移動します。タブには、Back-to-Origin設定項目が表示されます。
![](https://qcloudimg.tencent-cloud.cn/raw/eeea737602e1248ca1856a16a80df1b7.png)
5. Back-to-Origin設定では、デフォルトですべてのファイルのBack-to-Origin設定が無効になっています。必要に応じて、ファイルに複数のルールを追加するようにカスタマイズできます。また、ファイルの接尾辞、ファイルディレクトリ、フルパスファイルに基づいてBack-to-Origin of Rangeをマッチングすることができます。

    |設定項目|	説明|
    |--|--|
    |タイプ	|すべてのファイル、指定されたファイル接尾辞、ファイルディレクトリ、フルパスファイルを対象に設定できます。<br><br>すべてのファイル：すべてのファイルにこのBack-to-Origin of Rangeルールを使用します。デフォルトのルールは削除できません。<br>ファイル接尾辞：ファイルの接尾辞に従って、Back-to-Origin of Rangeルールを適用します。<br>ファイルディレクトリ：指定されたファイルディレクトリに従って、Back-to-Origin of Rangeルールを適用します。<br>フルパスファイル：Back-to-Origin of Rangeルールを適用する特定のパスファイルを指定できます。|
    |内容|	選択したファイルタイプによって、次のような内容の入力制約があります。<br>タイプがファイル接尾辞の場合：ファイル接尾辞の文字列でマッチングすることがサポートされます。複数の場合は「;」で区切ります。<br>タイプがファイルディレクトリの場合：「/test;/a/b/c」のようなファイルディレクトリの入力がサポートされます。ただし「/」で終わることはできません。複数の場合は「;」で区切ります。<br>タイプがフルパスファイルの場合：「/index.html;/test/\*.jpg」のようなファイルディレクトリの入力がサポートされます。ファイルパスは\*でマッチングすることがサポートされます。複数の場合は「;」で区切ります。|
    |Back-to-Origin of Range|	有効/無効がサポートされます。<br>有効：Back-to-Origin of Rangeを有効にすると、Back-to-Originをリクエストする時、Back-to-Origin of Rangeリクエストを使用します。有効にすると、ユーザリクエストにrangeリクエストが含まれていない場合、リクエストファイルが4Mより大きければ、CDNノードではサイズが1MのシャードでrangeリクエストをBack-to-Originします。ファイルが4Mより小さければ、CDNノードではBack-to-Originを行い完全なファイルを取得します。ユーザリクエストにrangeリクエストが含まれている場合、含まれたrangeリクエストに従って、back-to-originをリクエストします。<br>無効：Back-to-Origin of Rangeを無効にすると、Back-to-Originをリクエストする時、Back-to-Origin of Rangeリクエストを使用しません。|

### 推奨設定
ファイルサイズが4MBを超える場合は、そのファイルタイプに対してBack-to-Origin of Rangeを有効にすることをお勧めします。ファイルの一部のみが大容量の場合は、ファイルタイプ/ファイルディレクトリ/フルパスファイルでマッチングした一部の大容量ファイルにBack-to-Origin of Rangeを有効にし、他のファイルにBack-to-Origin of Rangeを使用しないように設定することをお勧めします。

### 設定の制約
Back-to-Origin of Range設定は、最大20件のルールを設定することをサポートします。ルールの優先順位は、一番下のルールが最も優先順位が高く、一番上のルールが最も優先順位が低い。ユーザーがファイルをリクエストすると、ルールの優先順位に従って順次マッチングします。マッチングに成功すると、優先順位が最も高いルールに従って優先的に実行されます。

## 設定例

**例1**
すべてのファイルでBack-to-Origin of Rangeを有効にする必要がある場合、ドメイン名`cloud.tencent.com`のBack-to-Origin of Rangeは次のように設定されます：
![](https://qcloudimg.tencent-cloud.cn/raw/1227e1b23eec3ceecad49b80ed64c5a0.png)
ユーザーAがリソース`http://cloud.tencent.com/test.ap`kをリクエストする場合は、ノードがリクエストを受信し、キャッシュされている`test.apk`ファイルがすでに期限切れであることが判明すると、Back-to-Originリクエストを送信します。ノードBack-to-OriginはRangeリクエストを使用し、シャードごとにリソースを取得してキャッシュします。この時に、ユーザーBも同様に同一ノードに同じファイルのRangeリクエストを送信し、ノードに保存されているシャードがすでにRangeリクエストで指定されたバイトセグメントと一致する場合、リソースはすべてのシャードの取得が完了するまで待つ必要がなく、直接ユーザーに返します。

**例2**
現在、一部のファイルのみがBack-to-Origin of Rangeを使用する必要がある場合、ドメイン名`cloud.tencent.com`のBack-to-Origin of Rangeは次のように設定されます：
![](https://qcloudimg.tencent-cloud.cn/raw/b0b80635b4291e10347621e07c7cd252.png)
ユーザーAがリソース`http://cloud.tencent.com/test.apk`をリクエストする場合、下のルールは上のルールよりも優先順位が高いので、ノードリソースがヒットしなかったり、キャッシュが期限切れになったりした場合、このリクエストはBack-to-Origin of Rangeを使用します。ユーザBがリソース`http://cloud.tencent.com/test.jpg`をリクエストし、このルールはすべてのファイルにのみマッチングする場合、そのリクエストにBack-to-Originが発生すると、Back-to-Origin of Rangeが使用されません。


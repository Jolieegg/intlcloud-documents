


## 設定シナリオ

Tencent Cloud CDNは、キャッシュ時にKey-Value形式を使用してリソースをマッピングします。Keyはキャッシュキーで、キャッシュされたリソースの一意の識別子です。キャッシュキールールを設定することにより、異なるファイルタイプのコンテンツに[フィルタリングパラメータ]と、[大文字と小文字を区別しない]機能を設定して、キャッシュキーを最適化できます。



### フィルタリングパラメータ

- ユーザーがURLを介してリソースにアクセスする場合、以下のリンクを使用して2つの異なる画像を表示するなど、いくつかの特別なパラメータを使用する場合があります。
`http://cloud.tencent.com/1.jpg?version=1`
`http://cloud.tencent.com/1.jpg?version=2`
このシナリオでは[フィルタリングパラメータ]機能を無効にする必要があり、完全なURLをキャッシュキーとして画像の内容をそれぞれキャッシュし、リソースを区別します。

- オーディオ・ビデオのシナリオで、タイムスタンプ署名パラメータを使用し、アクセス認証を行う場合：
`http://cloud.tencent.com/1.mp4?sign=XXXXXX`
このシナリオでは[フィルタリングパラメータ]機能を有効にする必要があります。「?」の前のリンク`http://cloud.tencent.com/1.mp4`をキャッシュキーとします。ノードは1つのリソースのみをキャッシュし、タイムスタンプ署名が絶えず変化している場合でも、署名認証を介してキャッシュに直接ヒットすることができます。

### 大文字小文字を区別しない

業務シナリオにおいて、リソースのURLパスの大文字と小文字の違いがリソースの内容に影響する場合は、[大文字小文字を区別しない]設定を無効にすることができます。
業務シナリオにおいて、リソースのURLパスの大文字と小文字の違いがリソースの内容に影響しない場合は、[大文字小文字を区別しない]設定を有効にし、ヒット率を上げることができます。
>!プラットフォームはアップグレード中であり、現在のところ大文字と小文字を区別しない設定を有効化することはできません。

## 設定ガイド

### 設定の確認

[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のメニューバーで【ドメイン名管理】を選択し、ドメイン名操作列の【管理】をクリックして、ドメイン名設定ページに移動します。Tabを【キャッシュ設定】に切り替えると、【キャッシュキールールの設定】が表示されます。

アクセラレーションドメイン名を追加する際には、業務タイプに応じて、[フィルタリングパラメータ]機能がデフォルトで無効または有効となります。

- アクセラレーションドメイン名で静的アクセラレーション業務タイプを選択した場合、フィルタリングパラメータはデフォルトでは無効です。キャッシュキールールの設定では、すべてのファイルルールの【フィルタリングパラメータ】が「フィルタリングしない」に同期されます。
- アクセラレーションドメイン名でダウンロードやストリーミングメディアのVOD業務タイプを選択した場合、[フィルタリングパラメータ]機能はデフォルトで有効になります。キャッシュキールールの設定では、すべてのファイルルールの【フィルタリングパラメータ】が「すべてフィルタリングする」に同期されます。


![](https://main.qcloudimg.com/raw/1f53ed863618b442233dd3e1bba6229b.png)

### ルールの追加

必要に応じてキャッシュキーのルールを追加できます。
<img src="https://main.qcloudimg.com/raw/48becf925518b2595097eddf7b4ec6d5.png" height="250" width="438" />

#### 設定の制約

- 1つのドメイン名で最大20件までキャッシュキールール（デフォルトルールを含む）を追加できます。
- 複数あるルールは優先順位を変更できます。下部の優先順位が上部のものよりも高くなります（デフォルトルールの優先順位を変更できません）。
- 1つのファイルタイプ/フォルダ/フルパスファイルルールでは、最大100グループのコンテンツを入力でき、異なるコンテンツ間は「;」で区切ります。例：ファイルタイプ - jpg;png。
- フィルタリングパラメータ - 指定されたパラメータを保持
  - すべてのファイル：最大6つのパラメータ名を入力でき、1つのパラメータ名の上限は20文字となります。
  - ファイルタイプ/フォルダ/フルパスファイル：最大5つのパラメータ名を入力でき、1つのパラメータ名の上限は20文字となります。
    複数のパラメータ名の間は「;」で区切ります。例：key1;key2;key3。

### ルールの変更

追加されたキャッシュキーのルールを変更することができます。キャッシュキーのルール操作欄の【変更】をクリックして変更します。

>!デフォルトルールはフィルタリングパラメータと、大文字と小文字を区別しない設定のみ変更可能であり、タイプとコンテンツの変更はサポートしていません。

### ルールの削除

追加されたキャッシュキーのルールを削除できます。キャッシュキーのルール操作欄の【削除】をクリックして削除します(デフォルトではルールを削除できません)。


## 設定例

アクセラレーションドメイン名 `www.test.com`の【キャッシュキールールの設定】が次の場合、
![](https://main.qcloudimg.com/raw/8c3f7f534c5fa849ca1594a0a244d840.png)

実際のアクセス状況は次のとおりです。

クライアントがリソース`www.test.com/abc.jpg?version=1&colour=red`と`www.test.com/abc.JPG?version=1&colour=red`をリクエストし、リクエストがいずれもCDNノードXにアクセスして、ノードXに上記の2つのリソースのキャッシュがない場合：

- オリジンサーバーへ戻って`abc.jpg`画像リソースを取得し、CDNノードX上にキャッシュするようにリクエストします。フィルタリングパラメータが「すべてフィルタリングする」になっているため、「?」以前のリンク`www.test.com/abc.jpg`がキャッシュキーになります。
- クライアントが`www.test.com/abc.JPG?version=1&colour=red`をリクエストする場合、大文字と小文字を区別しない設定が有効になっていないため、以前にキャッシュした`www.test.com/abc.jpg`リソースにヒットしません。オリジンサーバーへ戻って`abc.JPG`画像リソースを取得し、CDNノードX上にキャッシュするようにリクエストします。対応するキャッシュキーは`www.test.com/abc.JPG`になります。




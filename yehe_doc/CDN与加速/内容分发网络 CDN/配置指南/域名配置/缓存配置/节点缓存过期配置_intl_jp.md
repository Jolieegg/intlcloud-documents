ノードのキャッシュの有効期限の設定を利用すれば、CDNノードにキャッシュされたオリジンサーバーのリソースの有効期限を設定し、CDNノードにキャッシュされたオリジンサーバーのリソースを更新する頻度を調整することができます。業務ニーズに応じて、ディレクトリ、ファイルの拡張子、ファイルのフルパスでキャッシュするリソースの有効期限を設定することができます。

## 機能説明
CDNはノードのキャッシュの有効期限の設定で指定された有効期限に従って、CDNノードにキャッシュされたリソースが期限切れになったかを判断します。
- CDNノードにおける、ユーザーがアクセスするリソースのキャッシュが期限切れになっていない場合、CDNノードはそのままキャッシュをユーザーに返します。
- ユーザーのアクセスするリソースがCDNノードにキャッシュされていない場合、または、CDNノードにおける、ユーザーがアクセスするリソースのキャッシュが期限切れになった場合、CDNノードはオリジンサーバーから最新のリソースを取得しキャッシュすると同時に、ユーザーに返します。

オリジンサーバーのリソースを更新した直後に、CDNノードでのキャッシュを更新する必要がある場合、[キャッシュを更新](https://console.cloud.tencent.com/cdn/refresh) 機能を使用し、CDNノードで期限切れになっていないキャッシュを自発的に更新することで、CDNノードでのキャッシュとオリジンサーバーのリソースとの一致性を確保します。

## 注意事項
- キャッシュの有効期限はBack-to-Originの実行頻度に影響を与えます。業務ニーズに応じてリソースのキャッシュの有効期限を設定することをお勧めします。キャッシュの有効期限が短いと、CDNが頻繁にBack-to-Originを実行し、オリジンサーバーの帯域幅が増えます。キャッシュの有効期限が長いと、CDNのキャッシュの更新が遅れ、ユーザーが最新のリソースを取得することに影響します。
- CDNノードでは、[Tencent Cloud CDNキャッシュルールと優先度](#m1)に従ってリソースがキャッシュされます。ただし、CDNノードにキャッシュされたリソースは、リクエスト頻度が低い原因で、期限切れになっていなくても、ノードから削除されることがあります。
- オリジンサーバーにおけるリソースの更新前後に、異なるリソース名を使用することをお勧めします。例えば、バージョン(img-v1.jpg、img-v2.jpg)で中身が異なるリソースに名前を付けます。これは、オリジンサーバーでリソースが変わった後、CDNノードでキャッシュが期限切れになっていないため、古いリソースをユーザーに返すことを防ぐためです。
- 古いバージョン（標準モード）のノードのキャッシュの有効期限の設定機能を利用中の場合、高度モードでの設定をサブミットし、最新版のノードのキャッシュの有効期限の設定にアップグレードすることで、より多くの機能を利用することをお勧めします。高度モードにアップグレードした場合、元の標準モードに戻ることができないので、ご注意ください。古いバージョンのノードのキャッシュの有効期限の設定については、[ノードのキャッシュの有効期限の設定（旧）](https://intl.cloud.tencent.com/document/product/228/35317)をご参照ください
- オリジンサーバーでレスポンスヘッダーCache-Controlを設定することで、CDNノードにおけるキャッシュの有効期限（キャッシュオプション:オリジナルサーバーと同様）を制御することができます。なお、CDNノードでレスポンスヘッダーCache-Controlがユーザーに渡されるため、ブラウザのキャッシュの有効期限に対する制御が実現できます。CDNノードでブラウザのキャッシュの有効期限を設定する場合、[ブラウザのキャッシュの有効期限の設定](https://intl.cloud.tencent.com/document/product/228/38932) で、CDNノードからユーザーに渡すレスポンスヘッダーCache-Controlを指定してください。


## 設定説明
### 操作プロセス
1. [CDNコンソール](https://console.cloud.tencent.com/cdn)にログインします。
2. 左側のメニューで**ドメイン名管理**をクリックし、ドメイン名管理リストへ進みます。
3. 設定するドメイン名を選択し、**管理**をクリックして、ドメイン名の設定ページへ進みます。
4. **キャッシュ設定**をクリックし、キャッシュ設定タグに切り替えます。タグで**ノードキャッシュ期限の設定**を確認できます。
<br>
<img src="https://qcloudimg.tencent-cloud.cn/raw/cd08be49dbf25e88f28b32f019284231.png" width="850px">
<br>
5. **ルールを新規作成**をクリックし、新規ルールページへ進み、ノードのキャッシュの有効期限の設定を追加します。
<br>
<img src="https://qcloudimg.tencent-cloud.cn/raw/a57bc131850fc1a49c69e2aa86d0050e.png" width="450px">
<br>
<table>
<thead>
<tr>
<th>設定項目</th>
<th>説明</th>
</tr>
</thead>
<tbody><tr>
<td>タイプ</td>
<td>すべてのファイル、ファイルの拡張子、ファイルのディレクトリ、フルパスのファイル、ホームページを設定することが可能です。<br>すべてのファイル：すべてのファイルを指定してルールを設定します。デフォルトルールとします。<br>ファイルの拡張子：ファイルの拡張子を指定してルールを設定します。<br>ファイルのディレクトリ：ファイルのディレクトリを指定してルールを設定します。<br>フルパスのファイル：ファイルのフルパスを指定してルールを設定します。<br>ホームページ：ドメイン名のルートディレクトリを指定してルールを設定します。</td>
</tr>
<tr>
<td>詳細</td>
<td>選択したファイルタイプによって、入力する内容には制約があります。</br>タイプがすべてのファイルの場合、すべてのファイルとします。</br>タイプがファイルの拡張子の場合、ファイルの拡張子を入力できます。拡張子が複数ある場合、「；」で区切ります。例：jpg;png;css。</br>タイプがファイルのディレクトリの場合、ファイルのディレクトリを入力できます。「/」で終わらないでください。ディレクトリが複数ある場合、「；」で区切ります。例：/test;/a/b/c。</br>タイプがフルパスのファイルの場合、ファイルのフルパスを入力できます。フルパスが複数ある場合、「；」で区切ります。例：/index.html;/test/.jpg。</td>
</tr>
<tr>
<td>キャッシュオプション</td>
<td>オリジンサーバーと同様、キャッシュを格納する、キャッシュを格納しないルールで設定することが可能です。<br>オリジンサーバーと同様：オリジンサーバーのレスポンスヘッダーCache-Controlに応じて、CDNノードのキャッシュの有効期限を設定します。ヒューリスティックキャッシュへの設定をサポートします。<br>キャッシュを格納する：CDNノードのキャッシュの有効期限を設定します。強制キャッシュへの設定をサポートします。<br>キャッシュを格納しない：CDNノードでリソースをキャッシュしないことを設定します。<br></td>
</tr>
</tbody></table>

[](id:m1)	
### Tencent Cloud CDNキャッシュルールと優先度
#### キャッシュオプション：オリジンサーバーと同様
<img src="https://qcloudimg.tencent-cloud.cn/raw/0d0086b11c0e9968707865af46a4c23d.jpg" width="850px">



CDNノードで、オリジンサーバーのレスポンスヘッダーCache-Controlに応じてキャッシュの有効期限を設定します。
- オリジンサーバーのレスポンスヘッダーCache-Controlのフィールドがmax-ageである場合、max-ageの値に応じてCDNノードのキャッシュの有効期限を設定します。例えば、Cache-Control：max-age=300の場合、キャッシュの有効期限が300秒になります。
	- オリジンサーバーのレスポンスヘッダーCache-Controlのフィールドがno-cache 、no-storeまたはprivateである場合、CDNノードでリソースをキャッシュしません。
	- オリジンサーバーのレスポンスヘッダーにCache-ControlまたはExpiresがない場合、ヒューリスティックキャッシュの状態に応じてキャッシュルールを設定します。詳しくは以下のとおりです：
		- ヒューリスティックキャッシュが無効になり、オリジンサーバーのレスポンスヘッダーにCache-ControlまたはExpiresがない場合、キャッシュの有効期限は600秒とします。
		- ヒューリスティックキャッシュが有効になり、オリジンサーバーのレスポンスヘッダーにCache-ControlまたはExpiresがない場合、以下のルールに従ってヒューリスティックキャッシュの有効期限を設定します。
		 i. デフォルト設定：オリジンサーバーのレスポンスヘッダーにLast-Modifiedがある場合、キャッシュの有効期限は（現在の時間-Last-Modified）\* 0.1とします。オリジンサーバーのレスポンスヘッダーにLast-Modifiedがない場合、キャッシュの有効期限はデフォルトで600秒とします。
		 <br>
		 <img src="https://qcloudimg.tencent-cloud.cn/raw/80612ba1e40f345e14b188939cb7b557.png" width="450px">
		 <br>
		 ii. <b>カスタムポリシー</b>：ヒューリスティックキャッシュの有効期限を設定できます。
		 <br>
		 <img src="https://qcloudimg.tencent-cloud.cn/raw/06629eb849a9e56ee0c16db1f8bfe3c6.png" width="450px">
		 <br>

#### キャッシュオプション：キャッシュを格納する
<img src="https://qcloudimg.tencent-cloud.cn/raw/dc781cff77d79f57fa3c9df800e21a4d.jpg" width="850px">

CDNノードのキャッシュの有効期限を設定します。	
- 強制キャッシュの無効化：
	- オリジンサーバーのレスポンスヘッダーCache-Controlのフィールドがmax-ageである場合、または、オリジンサーバーのレスポンスヘッダーにCache-Controlがない場合、設定したCDNノードのキャッシュルールに従ってキャッシュを実行します。
	- オリジンサーバーのレスポンスヘッダーCache-Controlのフィールドがno-cache 、no-storeまたはprivateである場合、CDNノードでリソースをキャッシュしません。
	<br>
	<img src="https://qcloudimg.tencent-cloud.cn/raw/35f0cf1d08f6395e541ec9c1c5ae364b.png" width="450px">
	<br>
- 強制キャッシュの有効化：オリジンサーバーのレスポンスヘッダーCache-Controlを無視し、設定したCDNノードのキャッシュルールに従ってキャッシュを実行します。
<br>
<img src="https://qcloudimg.tencent-cloud.cn/raw/fb2670449e6c40f5df4e8231c8f050b0.png" width="450px">
<br>

#### キャッシュオプション：キャッシュを格納しない
CDNノードでリソースをキャッシュしないことを設定します。このリソースへの各ユーザーリクエストに対して、CDNはそのままBack-to-Originを実行しリソースを取得してユーザーに返します。
<img src="https://qcloudimg.tencent-cloud.cn/raw/621483c2535ca8e950e7a36c46c96983.png" width="450px">
<br>

#### キャッシュルールが複数存在する場合の優先度
同時に複数のキャッシュルールを設定した場合、上位のルールに比べ、下位のルールの**優先度が高い**です。**優先度を調整**をクリックし、キャッシュルールをドラッグして優先順を調整することができます。
<img src="https://qcloudimg.tencent-cloud.cn/raw/dcdbba45c63c0a18022fa73ecb76cb13.png" width="850px">	

### 推奨設定
- よく更新しないスタティックファイル(ピクチャータイプ、アプリケーションダウンロードタイプなど）の場合、キャッシュの有効期限に30日を設定することをお勧めします。
- 頻繁に更新するスタティックファイル（js、cssなど）の場合、業務の更新頻度に応じてキャッシュの有効期限を設定することをお勧めします。
- ダイナミックファイル（php、jsp、asp、aspxなど）の場合、**キャッシュを格納しないことを設定しなければなりません**。
- **サイトへのログイン**（wordpressバックグランドから/wp-adminにアクセスするなど）や**インターフェース検索**などオリジンサーバーと直接通信する必要がある他のリクエストの場合、**キャッシュを格納しないことを設定しなければなりません**。そうしないと、アクセスエラーが発生する可能性があります。

	
### 設定の制約
- 1つのドメイン名に対して、キャッシュルールを最大100件まで追加できます。
- ルールが複数存在する場合、下位のルールの優先度は上位のルールより高いです。
- 1つのファイルの拡張子/ファイルのディレクトリ/フルパスのファイルルールでは、最大100グループのコンテンツを入力できます。異なるコンテンツを「;」で区切ります。例：ファイル拡張子の場合、jpg;pngになります。	
- いかなるルールも設定していない場合、または、リクエストが設定されたルールをヒットしなかった場合、CDNノードでオリジンサーバーのレスポンスヘッダーCache-Controlに応じてキャッシュの有効期限を設定します。オリジンサーバーのレスポンスヘッダーにCache-Controlフィールドがない場合、CDNノードでこのリソースのキャッシュの有効期限はデフォルトで600sとします。
- CDNノードでは、GET、HEADタイプのリクエストだけをキャッシュし、 POSTやOPTIONSなど他のタイプのリクエストをキャッシュしません。


## 設定例
### 例1
元のキャッシュルールは、「ファイルの拡張子がphp;jsp;asp;aspxのリソースをキャッシュせず、他のファイルは全部30日とする」です。
<img src="https://qcloudimg.tencent-cloud.cn/raw/5129af6e01dd139afcf5c44a7ba97ef3.png" width="850px">
<br>
次のルール「ファイルの拡張子がjpg、pngのリソースは10日とし、かつ、オリジンサーバーのレスポンスヘッダーCache-Controlを無視する」を追加します。つまり、強制キャッシュを有効にします。他のすべてのファイルのキャッシュルールは、「オリジンサーバーと同様」に変更します。

1. **ルールを新規作成**をクリックし、タイプはファイルの拡張子、内容はjpg;png、キャッシュオプションは「キャッシュを格納する」、キャッシュの有効期限は10日、強制キャッシュは有効として、**OK**をクリックします。
<br>
<img src="https://qcloudimg.tencent-cloud.cn/raw/a1db0f8cbc470efa0b5749114ca8ea07.png" width="450px">
<br>
2. すべてのファイルのキャッシュルールを選択し、**変更**をクリックし、キャッシュオプションを「オリジンサーバーと同様」に変更して、**OK**をクリックします。
<br>
<img src="https://qcloudimg.tencent-cloud.cn/raw/c0442f19e230b69456f59d1874d784a9.png" width="450px">
<br>
3. 変更後のキャッシュルールは以下のとおりです：
	- ファイルの拡張子がjpg、pngのリソースのキャッシュの有効期限は10日とし、強制キャッシュを有効にします。
	- ファイルの拡張子がphp;jsp;asp;aspxのリソースをキャッシュしません。
	- 他のすべてのファイルのキャッシュの有効期限は30日とします。
	<br>
	<img src="https://qcloudimg.tencent-cloud.cn/raw/bfc24f2fca1ab9a184b0bf415c85a0f4.png" width="850px">
	<br>
	実際のキャッシュ状況は以下のとおりです：
	-  オリジンサーバーのレスポンスヘッダーCache-Controlのフィールドがno-cache、no-storeまたはprivateにもかかわらず、ノードにおける、`www.test.com/abc.jpg`リソースのキャッシュの有効期限は10日です。
	-  `www.test.com/def.php`リソースはノードにキャッシュされません。

	
### 例2
**WordPressを使用してサイトを構築したノードに対するキャッシュの有効期限の設定アドバイス**
- バックグラウンドからログインする/wp-adminディレクトリ配下のリソースに対して、キャッシュしないことを設定しなければなりません。そうしないと、バックグラウンドからのログインに関するリソースがキャッシュされ、ログインエラーが発生します。他にインターフェース関連のリソースに対しても、キャッシュしないことを設定してください。
- 拡張子がphp;jsp;asp;aspxであるダイナミックリソースに対して、キャッシュしない（CDNのデフォルトキャッシュルール）ことを設定してください。
- 拡張子がhtml;js;cssのファイルは頻繁に更新されるため、更新頻度に応じてキャッシュの有効期限を設定してください。キャッシュの有効期限に7日を設定し、強制キャッシュを無効にすることをお勧めします。
-  他のすべてのファイルのキャッシュの有効期限は30日とします（CDNのデフォルトキャッシュルール）。

**CDNのデフォルトキャッシュルールに加えて、以下の手順に従ってルールを追加します：**
1. **ルールを新規作成**をクリックし、タイプはディレクトリ、内容は/wp-admin、キャッシュオプションは「キャッシュを格納しない」として、**OK**をクリックします。
<br>
<img src="https://qcloudimg.tencent-cloud.cn/raw/93a9e55ac5c35bbe1e955eda302f41f1.png" width="450px">
<br>
2. **ルールを新規作成**をクリックし、タイプはファイルの拡張子、内容はhtml;js;css、キャッシュオプションは「キャッシュを格納する」、キャッシュの有効期限は7日、強制キャッシュは無効として、**OK**をクリックします。
<br>
<img src="https://qcloudimg.tencent-cloud.cn/raw/1e0248cf175dd0158f73300d3bf7dc2f.png" width="450px">
<br>
3. 下位のルールの優先度が上位のルールより高いため、**優先度を調整**をクリックし、「/wp-adminディレクトリをキャッシュしないルール」を最下位にドラッグし、優先度を最高にします。
<br>
<img src="https://qcloudimg.tencent-cloud.cn/raw/ba9b0809fc20a354ebadfbed4f19eee5.png" width="850px">
<br>
4. 変更後のキャッシュルールは以下のとおりです：
	- /wp-adminディレクトリ配下のすべてのリソースをキャッシュしません。
	- ファイルの拡張子がhtml;js;cssのリソースのキャッシュの有効期限は7日とします。
	- ファイルの拡張子がphp;jsp;asp;aspxのリソースをキャッシュしません。
	- 他のすべてのファイルのキャッシュの有効期限は30日とします。
	<br>
	<img src="https://qcloudimg.tencent-cloud.cn/raw/da6e9921da144c97f7b80e569f2d8444.png" width="850px">
	<br>

## よくあるご質問
- [オリジンサーバーでファイルが変更された後、CDNアクセラレーションノード上のキャッシュはリアルタイムで自動的に更新されますか？](https://intl.cloud.tencent.com/document/product/228/11203)
- [どのようにユーザーからのアクセスがCDNノードのキャッシュをヒットしているかを判断しますか？](https://intl.cloud.tencent.com/document/product/228/11203)

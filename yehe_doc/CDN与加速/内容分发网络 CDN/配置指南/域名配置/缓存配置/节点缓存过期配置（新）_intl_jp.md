## 設定シナリオ

Tencent Cloud CDNのリソースキャッシュは、リクエストによってトリガーされます。ユーザーがリソースへのアクセスリクエストを開始したときに、リクエストを受け取ったCDNノードがリクエストされたリソースをキャッシュしていない場合は、リクエストをオリジンサーバーに転送してリソースを取り出します。リソースを正常に取り出した後（2XXステータスコードが返されます）、リソースはノードにキャッシュされ、ユーザーに返されます。

お客様はCDNノードにキャッシュされたリソースを直接管理することはできません。オリジンサーバーのリソースが変更されてもCDNノードがレガシーリソースをキャッシュしてユーザーに返す恐れがある場合は、ノードキャッシュルールを設定することで、ある程度制御することができます。

> ! キャッシュには現在、32G以内というファイルサイズの制限があります。この制限を超えると正常なキャッシュが行われず、back-to-originによりリソースが取得されます。

## 設定ガイド

### 設定の確認

[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のメニューバーで**ドメイン名管理**を選択し、ドメイン名操作列の**管理**をクリックして、ドメイン名設定画面に入ります。Tabを**キャッシュ設定**に切り替えると、**ノードキャッシュ期限切れ設定**が表示されます。

アクセラレーションドメイン名にアクセスする場合、異なるサービスタイプに応じて、CDNはデフォルトのノードキャッシュ期限切れルールを追加します。これは必要に応じて変更できます。

- 静的アクセラレーションサービスタイプを選択した場合、通常の動的ファイル（php、jsp、asp、aspxなど）はデフォルトでキャッシュされず、他のすべてのファイルはデフォルトで30日間キャッシュされます。
 ![](https://main.qcloudimg.com/raw/5f48bc5246397975544baadf5ac81f4e.png)
- ダウンロードアクセラレーション、ストリーミングメディアVODアクセラレーションサービスタイプを選択した場合、デフォルトでは、すべてのファイルのキャッシュ期間は30日間です。
![](https://main.qcloudimg.com/raw/cdd00154330b8cb217287874f4f40693.png)

### ルールの追加

ファイル拡張子（jpg、pngなど）、ファイルディレクトリ（/testなど）、フルパスファイル（/test/1.jpgなど）の指定をサポートし、ノードキャッシュ動作を設定します。
<img src="https://main.qcloudimg.com/raw/5454a77683dca1cfb491eccdae839aa4.png" height="207" width="408" />

- オリジンサーバーに準じる：オリジンサーバーのCache-Controlヘッダーに準じます。
- オリジンサーバーに対応するResponse HTTP HeaderにCache-Controlフィールドが存在している場合、デフォルトのポリシーは次のとおりです。
  Cache-Controlフィールドがmax-ageの場合、CDNノードキャッシュリソース時間はmax-age値に従います。
   Cache-Controlフィールドがno-cache 、no-storeまたはprivateである場合、CDNノードはこのリソースをキャッシュしません。
- オリジンサーバーに対応するHTTP Response HeaderにCache-Controlフィールドが存在しない場合、CDNノードはこのリソースをキャッシュしません。
  **注：**一部のプラットフォームではこの時以下のデフォルトポリシーがあります：初回リクエストは始めに戻って、CDNノードはこのリソースをキャッシュし、再度リクエストしてノードキャッシュにヒットしたとき、CDNはデフォルトでCache-Control: max-age=600のヘッダーを追加します。
- キャッシュ：リソースがCDNノードにあるキャッシュ時間を設定します。
- 強制キャッシュ：「キャッシュ」を選択するとき、強制キャッシュするか、すなわちオリジンサーバーのCache-Control: no-cache/no-store/privateを無視するかの、追加設定をサポートします。デフォルトは「いいえ」です。
  **注：**「強制キャッシュ」で「はい」を選択すると、CDNノードキャッシュリソース時間はここでの設定時間に従います。
  　　「強制キャッシュ」で「いいえ」を選択し、かつオリジンサーバーのCache-Controlフィールドがno-cache/no-store/privateの場合は、キャッシュ時間を設定しても、CDNノードもリソースをキャッシュしません。
- キャッシュしません：CDNノードはリソースをキャッシュしません。





#### 設定の制約

- 1つのドメイン名で最大100件までのキャッシュルールを追加できます。
- 複数あるルールは優先順位を変更できます。下部の優先順位が上部のものよりも高くなります
  **注：**「max-age機能なし」はバージョンアップ中のため、現時点ではサポートしておりません。次回のリリースまでお待ちください。このルールをすでに設定している場合は、ルールを削除するか、すべてのファイルのルールに変更することをお勧めします。
- 1つのファイル拡張子/ファイルディレクトリ/フルパスファイルルールでは、最大100グループのコンテンツを入力でき、異なるコンテンツ間は「;」で区切ります。例：ファイル拡張子 - jpg;png。

> ! 既存のものがノードキャッシュ期限切れの設定（旧）（つまり基本モード）である場合、詳細モード設定で送信された後に完全にアップグレードされ、元の基本モードに戻すことはできません。



### プラットフォームのデフォルトポリシー

いずれのルールも設定しない場合や、設定されたルールにリクエストがヒットしない場合は、デフォルトで次のようなプラットフォームポリシーに準じます。

- ユーザーがあるサービスリソースをリクエストし、オリジンサーバーに対応するHTTP Response HeaderにCache-Controlフィールドが存在している場合は、このCache-Controlに準じます。
- オリジンサーバーに対応するHTTP Response HeaderにCache-Controlフィールドが存在しない場合、CDNノードはデフォルトでこのリソースを600秒間キャッシュします。

## 設定例

アクセラレーションドメイン名`www.test.com`の**ノードキャッシュ期限切れ設定**が次の場合、
![](https://main.qcloudimg.com/raw/c1402003c4549d2e6035420921f67bd0.png)

実際のキャッシュ設定は以下のとおりです。

- `www.test.com/abc.jpg`リソースノードのキャッシュ時間は、オリジンサーバーのCache-Controlフィールドがno-cache/no-store/privateだとしていても、10日とします。
- `www.test.com/def.php`リソースはノードにキャッシュされません。

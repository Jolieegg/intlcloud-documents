
## 設定シナリオ
Tencent Cloud CDNのリソースキャッシュは、リクエストによってトリガーされます。ユーザーがリソースへのアクセスリクエストを開始したときに、リクエストを受け取ったCDNノードがリクエストされたリソースをキャッシュしていない場合は、リクエストをオリジンサーバーに転送してリソースを取り出します。リソースを正常に取り出した後（2XXステータスコードが返されます）、リソースはノードにキャッシュされ、ユーザーに返されます。

お客様はCDNノードにキャッシュされたリソースを直接管理することはできません。オリジンサーバーのリソースが変更されてもCDNノードがレガシーリソースをキャッシュしてユーザーに返すことが心配な場合は、ノードキャッシュルールを設定することで、ある程度制御することができます。

各CDNノードのキャッシュリソースには有効期限があります。リクエストされたキャッシュリソースが期限切れになった場合、リソースがノードにキャッシュされている場合でも、そのリソースは無効と見なされます。ノードは、オリジンサーバーからリソースを再度取り出します。ノードキャッシュルール設定は、特定のタイプ、特定のディレクトリ、パスのリソースがノードでのキャッシュ有効期限を指定することができます。実際のビジネスシナリオに従って設定できます。

## 設定ガイド
### 設定の確認
[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のナビゲーションメニューバーで【ドメイン名管理】を選択して、ドメイン名の右側にある【管理】をクリックすると、ドメイン名設定画面に入ります。第3欄の【キャッシュ設定】タブで、キャッシュ有効期限の設定を見つけます。
アクセラレーションドメイン名にアクセスする場合：
+ 静的アクセラレーションを選択した場合、通常の動的ファイル（php、jsp、asp、aspxなど）のデフォルトのキャッシュ有効期限は0（キャッシュせずに直接back-to-origin）であり、他のすべてのファイルタイプのデフォルトの有効期限は30日間です。
+ ダウンロードアクセラレーション、ストリーミングメディアVODアクセラレーションを選択した場合、すべてのファイルのデフォルトのキャッシュ有効期限は30日間です。

![](https://main.qcloudimg.com/raw/43e457600f1d0036c23dff9d091da34d.png)

### 設定の変更
#### 1. 設定を変更する
CDNサービスは現在、次の4種類のキャッシュ有効期限ルールをサポートしています。
+ ファイルタイプ：入力されたファイル拡張子に応じてキャッシュ有効期限を設定します。形式は`jpg;css`のようなファイル形式で、異なる拡張子間は`;`で区切る必要があります。
+ フォルダ：入力されたディレクトリパスに応じてキャッシュ有効期限を設定します。形式は `/test`で、`/`で終了する必要はありません。異なるディレクトリ間は`;`で区切ります。
+ フルパスファイル：完全なファイルパスを指定してキャッシュ有効期限を設定します。形式は`/index.html`で、完全なファイルパスとファイルタイプのマッチングモード（`/test/*.jpg`など）をサポートします。
+ ホームページ：ルートディレクトリに応じてキャッシュ有効期限を設定します。

![](https://main.qcloudimg.com/raw/b9be3726c932508d5705a773816cea26.png)
**設定ルール：**

+ キャッシュ有効期限ルールは最大10件まで設定できます。
+ 複数のキャッシュ有効期限ルールがある場合、ルールは優先順位としては一番下なので、一番最後のルールにしておるのですが、常に最優先されてしまいます。
+ キャッシュ有効期限は、最大365日まで設定できます。

> アクセラレーションドメイン名がグローバルアクセラレーション用に設定されている場合、設定されたキャッシュ有効期限はグローバルに有効になり、中国本土と中国本土以外で異なる設定をサポートしていません。

#### 2. プラットフォームポリシー
ユーザーが特定のビジネスリソースをリクエストすると、オリジンサーバーに対応するHTTP Response HeaderにCache-Controlフィールドが含まれている場合、デフォルトのプラットフォームポリシーは次の通りです。
- Cache-ControlフィールドがMax-Ageの場合、このリソースに対するキャッシュ時間は設定されているキャッシュ有効期限に準じ、Max-Ageの指定時間は継承されません。
- Cache-Controlフィールドはno-cache 、no-storeまたはprivateである場合、CDNノードはこのリソースをキャッシュしません。
- Cache-Controlフィールドがなく、リクエストがCDNキャッシュにヒットした場合、CDNはデフォルトで`Cache-Control:max-age = 600`ヘッダーを追加します。 

#### 3. 高度なキャッシュ設定
高度なキャッシュ設定を有効にすると、ユーザーは、オリジンサーバーのHTTP Response Header Cache-ControlのMax-Age値を調整することにより、ノードキャッシュの有効期限を動的に調整できます。

高度なキャッシュ設定を有効にした後、CDNは設定されたノードキャッシュの有効期限をMax-Age値と比較し、小さい方をノードキャッシュの有効期限として使用します。
+ オリジンサーバーの/index.htmlに設定されたMax-Ageが200秒で、CDNに設定されたキャッシュ有効期限が600秒の場合、ファイルがノードにおける実際のキャッシュ有効期限は200秒となります。
+ オリジンサーバーの/index.htmlに設定されたMax-Ageが800秒で、CDNに設定されたキャッシュ有効期限が600秒の場合、フファイルがノードにおける実際のキャッシュ有効期限は600秒となります。

> 高度なキャッシュ設定を有効にした後、オリジンサーバーがLast-Modifiedフィールドを返さない場合、CDNはデフォルトでLast-Modifiedフィールドを追加し、10分ごとにその値を変更します。

## 設定例
アクセラレーションドメイン名`cloud.tencent.com`のキャッシュ有効期限ルールが次のように設定されている場合：
![](https://main.qcloudimg.com/raw/36a6bfe2001e73c0a8a24e669c1b3a52.png)
実際のキャッシュ有効期限は次のとおりです。

1. `/test/abc.jpg` ファイルのノードキャッシュ有効期限は200秒です。
2. `/test/def.jpg` ファイルのノノードキャッシュ有効期限は400秒です。
3. `/test/1.png` ファイルのノードキャッシュ有効期限は300秒です。


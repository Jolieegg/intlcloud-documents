ノードキャッシュの期限切れ設定はすでに包括的にアップグレードしました。詳細モードはよりきめ細かな設定に対応するようになりました。詳細については、[ノードキャッシュ期限切れ設定（新）](https://intl.cloud.tencent.com/document/product/228/38424)をご参照ください。 

## 設定の概要
Tencent Cloud CDNのリソースキャッシュは、リクエストによってトリガーされます。ユーザーがリソースへのアクセスリクエストを開始したときに、リクエストを受け取ったCDNノードがリクエストされたリソースをキャッシュしていない場合は、リクエストをオリジンサーバーに転送してリソースを取り出します。リソースを正常に取り出した後（2XXステータスコードが返されます）、リソースはノードにキャッシュされ、ユーザーに返されます。

お客様はCDNノードにキャッシュされたリソースを直接管理することはできません。オリジンサーバーのリソースが変更されてもCDNノードがレガシーリソースをキャッシュしてユーザーに返す恐れがある場合は、ノードキャッシュルールを設定することで、ある程度制御することができます。

各CDNノードのキャッシュリソースには「有効期限」の概念があります。リクエストされたキャッシュリソースが期限切れになると、リソースがノードにキャッシュされている場合でも、そのリソースは無効と見なされ、再度back-to-originのプルを行います。ノードキャッシュルールでは、ノードでの特定のタイプ、特定のディレクトリ、パスのリソースのキャッシュ有効期限の指定がサポートされており、実際のビジネスシナリオに従って設定することができます。

>! キャッシュには現在、32G以内というファイルサイズの制限があります。この制限を超えると正常なキャッシュが行われず、back-to-originによりリソースが取得されます。

## 設定ガイド
### 設定の確認
[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のメニューバーで【Domain Management】を選択し、ドメイン名操作列の【管理】をクリックして、ドメイン名設定画面に入ります。Tabを【キャッシュ設定】に切り替えると、【ノードキャッシュ期限切れ設定】が表示されます。
![](https://main.qcloudimg.com/raw/834d620b98c9d7d387547e59a7e6a1f4.png)

### ルールの追加

CDNサービスは現在、以下の4種類のノードキャッシュ期限切れルールをサポートしています。
+ ファイルタイプ：入力されたファイル拡張子に応じてキャッシュの有効期限を設定します。形式は`jpg;css`のようなファイル形式で、異なる拡張子間は`;`で区切る必要があります。
+ フォルダ：入力されたディレクトリパスに応じてキャッシュの有効期限を設定します。形式は `/test`で、`/`で終了する必要はありません。異なるディレクトリ間は`;`で区切る必要があります。
+ フルパスファイル：完全なファイルパスを指定してキャッシュの有効期限を設定します。形式は`/index.html`で、完全なファイルパスとファイルタイプのマッチングモード（`/test/*.jpg`など）をサポートします。
+ ホームページ：ルートディレクトリに応じてキャッシュの有効期限を設定します。

<img src="https://main.qcloudimg.com/raw/1a72478ce0bc4fc1ef6a22bcb8064a6b.png" style="width:400px"/>

**設定の制約：**
- 1つのドメイン名で最大20件までのキャッシュルールを追加できます。
- 複数あるルールは優先順位を変更できます。下部の優先順位が上部のものよりも高くなります
- 1つのファイルタイプ/フォルダ/フルパスファイルルールでは、最大100グループのコンテンツを入力でき、異なるコンテンツ間は「;」で区切ります。例：ファイルタイプ - jpg;png。
- キャッシュ期間は最大365日まで設定できます。

>! 【モード】選択項目の中で「上級モード」を選択し、ルールを送信すると、上級モードに全面的にアップグレードされます。詳細については、[ノードキャッシュ期限切れ設定（新）](https://intl.cloud.tencent.com/document/product/228/38424)をご参照ください。アップグレードした後は、元の基本モードに戻すことはできません。


#### 高度なキャッシュ期限切れ設定スイッチ
有効にすると、CDNは命中したキャッシュルールのキャッシュ時間をオリジンサーバーのmax-age値と比較し、小さい方を実際の有効キャッシュ時間とします。

- オリジンサーバー設定‵/index.html‵のMax-Ageが200秒で、CDNに設定されたキャッシュ時間が600秒の場合、ノードでのファイルの実際のキャッシュ時間は200秒になります。
- オリジンサーバー設定`/index.html`のMax-Ageが800秒で、CDNに設定されたキャッシュ時間が600秒の場合、ノードでのファイルの実際のキャッシュ時間は600秒になります。

> !有効にした後、オリジンサーバーがLast-Modifiedフィールドを返さない場合、CDNはデフォルトでLast-Modifiedフィールドを追加し、10分ごとにその値を変更します。

#### オリジンサーバー準拠のスイッチ
有効にすると、リクエストが設定されたキャッシュルールのいずれにもヒットしない場合、オリジンサーバーに準拠します。

>! オリジンサーバー準拠のスイッチを有効にすると、高度なキャッシュ期限切れ設定スイッチは有効にできません。どちらか一方のみを有効にすることができます。


###  プラットフォームのデフォルトポリシー
いずれのスイッチも有効にせず、かついかなるルールも設定しない場合、またはリクエストが設定したルールにヒットしない場合、デフォルトで次のようなプラットフォームポリシーに準じます。
- ユーザーがあるサービスリソースをリクエストし、オリジンサーバーに対応するHTTP Response HeaderにCache-Controlフィールドが存在している場合は、このCache-Controlに準じます。
- オリジンサーバーに対応するHTTP Response HeaderにCache-Controlフィールドが存在しない場合、CDNノードはデフォルトでこのリソースを600秒間キャッシュします。


## 設定例
アクセラレーションドメイン名`cloud.tencent.com`のノードキャッシュ期限切れが次のように設定されている場合、
![](https://main.qcloudimg.com/raw/a585a6b560cb0e555b71e08bea179353.png)
実際のキャッシュ時間は次のとおりです。

1. `/test/def.jpg` ファイルのノードキャッシュ時間は400秒です。
2. `/test/1.png`ファイルのノードキャッシュ時間は5分間です。
3. 他のファイルノードのキャッシュ時間は30日間です。

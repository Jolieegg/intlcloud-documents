
## 설정 시나리오
Tencent Cloud CDN의 리소스 캐싱은 트리거 형식으로 이루어집니다. 사용자가 어떤 리소스에 액세스하기 위해 요청을 보냈을 때, 이 요청이 히트한 CDN 노드에 해당 리소스가 캐싱되어 있지 않았다면 사용자의 원본 서버로 돌아가 리소스를 가져옵니다. 리소스를 성공적으로 가져온(2XX 상태 코드) 다음에는 노드에 캐싱하고 사용자에게 리턴합니다.

CDN 노드에 캐싱된 리소스를 직접적으로 관리할 수 없는 상황에서, 원본 서버 리소스에 변동이 있음에도 CDN 노드에서 오래된 리소스를 캐싱하여 사용자에게 리턴할 우려가 있다면, 노드 캐시 규칙을 설정함으로써 일정 수준 제어할 수 있습니다.

각 CDN 노드에 캐싱된 리소스에는 '만료 시간'이라는 개념이 있습니다. 요청한 캐시 리소스가 이미 만료되었다면 노드에 캐싱되어 있어도 무효한 것으로 간주하여 다시 Origin-pull을 통해 가져옵니다. 노드 캐시 규칙 설정은 특정 유형, 디렉터리, 경로의 리소스에 대해 노드 캐시 만료 시간을 지정할 수 있도록 지원하며, 실제 서비스 시나리오에 맞게 설정할 수 있습니다.

## 설정 가이드
### 설정 조회
[CDN 콘솔](https://console.cloud.tencent.com/cdn)에 로그인하여 메뉴에서 [도메인 관리]를 선택하고 도메인 오른쪽의 [관리]를 클릭하면, 도메인 설정 페이지의 세 번째 메뉴인 [캐시 구성]에서 캐시 만료 설정을 확인할 수 있습니다.
가속 도메인 연동 시,
+ 정적 가속을 선택했을 경우, 일반 동적 파일(예: php, jsp, asp, aspx)의 캐시 만료 시간 기본값은 0이며(캐싱하지 않고 바로 Origin-pull), 다른 모든 파일의 만료 시간 기본값은 30일입니다.
+ 다운로드 가속, 스트림 미디어 VOD 가속을 선택했을 경우, 모든 파일의 캐시 만료 시간 기본값은 30일입니다.

![](https://main.qcloudimg.com/raw/43e457600f1d0036c23dff9d091da34d.png)

### 설정 변경
#### 1. 설정 변경
CDN은 현재 네 가지 유형의 캐시 만료 규칙 설정을 지원하며, 이는 다음과 같습니다.
+ 파일 유형: 입력한 파일 확장자에 따라 캐시 만료 시간을 설정합니다. 형식은 `jpg;css` 등의 파일 형식이며, 다른 확장자 사이에 `;`를 넣어 구분합니다.
+ 폴더: 입력한 디렉터리 경로에 따라 캐시 만료 시간을 설정합니다. 형식은 `/test`이며 `/`으로 끝맺지 않아도 됩니다. 또한, 다른 확장자 사이에 `;`를 넣어 구분합니다.
+ 전체 경로 파일: 온전한 전체 파일 경로를 지정하여 캐시 만료 시간을 설정합니다. 형식은 `/index.html`이며, `/test/*.jpg`와 같이 전체 경로 및 파일 유형을 결합할 수 있습니다.
+ 홈 페이지: 루트 디렉터리에 캐시 만료 시간을 설정합니다.

![](https://main.qcloudimg.com/raw/b9be3726c932508d5705a773816cea26.png)
**규칙 설정:**

+ 캐시 만료 헤더 규칙은 최대 10개까지 설정할 수 있습니다.
+ 여러 개의 캐시 만료 규칙 중 우선순위는 아래쪽이 우선입니다.
+ 캐시 만료 시간은 최대 365일까지 설정할 수 있습니다.

> !사용자 가속 도메인의 서비스 지역이 글로벌 가속일 경우 설정한 캐시 만료 시간이 글로벌 범위에 적용되며, 중국 내와 중국 외를 다르게 설정할 수 없습니다.

#### 2. 플랫폼 정책
사용자로부터 특정 서비스 리소스를 요청 받았을 때, 원본 서버에 상응하는 HTTP Response 헤더에 Cache-Control 필드가 존재할 경우 기본 플랫폼 정책은 다음과 같습니다.
- Cache-Control 필드가 max-age인 경우, 해당 리소스의 캐시 시간은 설정된 노드의 캐시 만료 시간을 기준으로 하며 Max-age로 지정된 시간을 따르지 않습니다.
- Cache-Control 필드가 no-Cache, no-store 혹은 private인 경우, CDN 노드에서 해당 리소스를 캐싱하지 않습니다.
- Cache - Control 필드가 없는 경우, 요청이 CDN 캐시에 히트할 때 `Cache - Control: max - age = 600 `헤더를 추가하도록 기본 설정되어 있습니다. 

#### 3. 고급 캐시 설정
고급 캐시 설정을 활성화하여 원본 서버의 HTTP Response Header Cache-Control에서 Max-Age 값으로 노드의 캐시 시간을 동적으로 조정할 수 있습니다.

활성화한 후에는 CDN에서 이미 설정한 노드 캐시 시간과 Max-Age 값을 비교하여 더 작은 쪽을 실제 노드 캐시 시간으로 적용합니다.
+ 사용자의 원본 서버가`/index.html`의 max-age를 200초로 설정했고, CDN에서 설정한 캐시 시간이 600초라면, 노드 내 파일의 실제 만료 시간은 200초가 됩니다.
+ 사용자의 원본 서버가`/index.html`의 max-age를 800초로 설정했고, CDN에서 설정한 캐시 시간이 600초라면, 노드 내 파일의 실제 만료 시간은 600초가 됩니다.

> !고급 캐시 설정을 활성화할 때 원본 서버에서 Last-Modified 필드를 리턴하지 않는다면 CDN이 Last-Modified 필드를 추가하고 10분마다 변경하도록 기본 설정되어 있습니다.

## 설정 예시
가속 도메인 'cloud.tencent.com'의 캐시 만료 규칙 설정이 아래와 같을 경우,
![](https://main.qcloudimg.com/raw/36a6bfe2001e73c0a8a24e669c1b3a52.png)
실제 캐시 시간은 다음과 같습니다.

1. `/test/abc.jpg` 파일 노드의 캐시 만료 시간은 200초입니다.
2. `/test/def.jpg` 파일 노드의 캐시 만료 시간은 400초입니다.
3. `/test/1.png` 파일 노드의 캐시 만료 시간은 300초입니다.


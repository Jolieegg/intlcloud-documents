CDNは自己診断ツールを提供します。いずれかのURLへの異常なアクセスを発見した場合、このツールは自己検出を実行する上で役立ちます。自己検出プロセスには、アクセスドメイン名のDNS解決の検出、リンク品質の検出、ノードステータスの検出、オリジンサーバーの検出やデータアクセスの一致性など、一連の診断項目が含まれており、問題の特定を支援し、解決策を提供します。

>! 診断用のリソースURLは、お客様のアカウントでアクセスした、ステータスが**起動済み**のドメイン名である必要があります。診断で発生する帯域幅は、課金帯域幅に計上されます。診断の対象となるリソースは200MBytes以下にすることをお勧めします。



## 障害診断
### 診断フロー

いずれかのリソースURLに異常なアクセスが発見された場合、**障害診断**を介して検出を開始することができます。手順は次のとおりです。
1. [CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側メニューバーから【診断ツール】>【自己診断ツール】を選択します。
2. 「障害診断」画面で、診断したい異常なURLを入力します。URLに、`http://`または`https://`というプレフィックスを付けて入力する必要があります。
 ![](https://main.qcloudimg.com/raw/0b5b89dee36676027aeb15a118b4584e.png)
3. URLを入力後、【診断リンクの生成】をクリックすると、診断リンクのアドレスが画面に表示されます。
 ![](https://main.qcloudimg.com/raw/35e6dc6b335db10c63dc729cbe11ddbe.png)
4. 診断リンクをクリックすると、新しい診断画面が開き、診断情報の収集が開始されます（診断プロセス中に検出画面を閉じないでください。診断が終了したら、この画面は手動で閉じることができます）。
    ![](https://main.qcloudimg.com/raw/1e41c147e1e0ae216efc6635a43b1298.png)
5. 診断リンクを他者に送信して、ローカル側の障害を検出することもできます。検出が完了したら、ブラウザの画面は手動で閉じる必要があります。

>!
>- 各URLで生成される診断リンクの有効期間は24時間で、障害診断は10回までクリックすることができます。
>- 「診断レポート」画面で、生成された利用可能な診断リンクを再度コピーすることができます。

## 診断レポート
### レポートの確認
1. 診断が完了したら、【診断レポート】をクリックして画面に進むと、生成された診断レポートが時系列でテーブルに表示され、リストが順番に表示されます。
	- 診断リンクのURLを生成します。
	- URLに対応する診断リージョン。
	- URLに対応する診断リンク。
	- 診断リンクの生成時間。
	- 診断リンクの生成ステータス。
	- 診断リンクで利用可能な診断回数。

![](https://main.qcloudimg.com/raw/47c48777ace8428bb065695e1475600e.png)

2. 操作バーの【展開】をクリックすると、それぞれの診断で生成されたレポートと結果を確認することができます。
![](https://main.qcloudimg.com/raw/a439f2dbcadcb6d2790e846416717cea.png)
3. 診断レポートではそれぞれの手順の検出に基づいて、次のように全体的な判定が行われます。
 - 正常
 - 異常
 - 診断画面が異常終了する（ほとんどの場合、診断が完了していない状態で診断画面を閉じることによって生じます）。
4. 右側の【レポートの確認】をクリックすると、診断の詳細と異常な状況への推奨する対処方法が表示されます。

### レポートの解読
1. レポートの最初の部分には、次のような診断情報が表示されます。
 - 診断レポートID。
 - 診断が必要なURL。
 - 診断をトリガーする時間。
![](https://main.qcloudimg.com/raw/a7b7c60533782c95927d4860491594fd.png)

2. レポートの2番目の部分には、診断プロセスの概要と各モジュールの結果が表示されます。異常なモジュールを直感的に発見することができます。診断モジュールには次の事項が含まれます。
 - クライアント情報の検出結果。
 - DNSの検出結果。
 - CNAMEの検出結果。
 - ネットワークリンクの検出結果。
 - ノード検出へのアクセス結果。
 - back-to-originノードの検出結果。
 - オリジンサーバーの検出結果。
![](https://main.qcloudimg.com/raw/1298a6d0b2e72b70ca202a03660b409f.png)

3. レポートの3番目の部分では、診断結果の詳細な説明を行います。
 #### 第1項：クライアント情報
取得したクライアントIP情報、対応する省/キャリア、HTTP/HTTPSリクエストを発信したUser-Agent、Referer、Request Methodなどの情報。クライアント情報の取得に失敗すると、それ以降の部分に対する検出が実行できなくなります。
![](https://main.qcloudimg.com/raw/8219224766176ed87ebb421330170f4a.png)

 #### 第2項：DNS検出
クライアントのローカルDNS IPを取得し、クライアントIPとDNS IPの帰属が同じであるか確認することによって、ローカルDNSの設定の異常に起因して、最適なアクセラレーションノードのスケジューリングができなくなっているのかどうかを判断することができます。
![](https://main.qcloudimg.com/raw/4ab79b159c3e983cd6db7c1fefeae9ea.png)

 #### 第3項：CNAME検出
検出ドメイン名のCNAME設定を取得します。ドメイン名のCNAME解決では、正しい*.cdn.dnsv1.com（デフォルト）拡張子ドメイン名として設定する必要があります。設定しない場合、リクエストはCDNノードに到達しません。
![](https://main.qcloudimg.com/raw/c3bbbb52440985415d9433b838dbde42.png)
>!CNAME設定はチェックされず、リクエストはノードに到達せず、それ以降の検出は実行されなくなります。

 #### 第4項：ネットワークリンクの検出
クライアントを介してローカルで複数のインターネットサイトを検出し、クライアントのネットワークステータスを取得します。 ローカルエージェントなどの設定によってサイトにアクセスできない場合、ネットワークリンクの検出に失敗し、それ以降の検出は実行できなくなります。
![](https://main.qcloudimg.com/raw/be249d3593b9956bf4e03393f02bb1d4.png)

 #### 第5項：アクセスノード検出
クライアントがリクエストを開始した後、到達したCDNノード情報が収集されます。これには、ノードIP、ノードの省/キャリア、ノードから返されたステータスコード、ヒットステータス、リソースMD5が含まれます。
 - ノードがこのリソースをキャッシュしている場合、直接ヒットし、back-to-originノードの検出は実行されません。
 - ノードがヒットしない場合、それ以降のback-to-originノードの検出が続行されます。
 - URLフィードバックのステータスコードが301、302、504 の場合、ノード検出情報が正常に取得できず、それ以降の検出が実行できなくなります。
 - ドメイン名にアクセス制御ポリシーが設定されている場合、アクセスノードは直接403を返し、ヒット状況は**ヒット済み**となります。
![](https://main.qcloudimg.com/raw/cce938713c83879c50899efb71b9ea2e.png)

 #### 第6項：back-to-originノードの検出
 1. リソースがCDNノードによって直接返される場合、この時点で、アクセスノードとback-to-originノードのヒットステータスは、両方とも**ヒット済み**となります。CDNは引き続きオリジンサーバーの検出を実行して、オリジンサーバーから返されたステータスコードと内容がノードと一致しているかどうかを検証しやすくします。
![](https://main.qcloudimg.com/raw/88ec7bc47877ef3c96b468a2a9c19a00.png)
 2. リソースがCDNノードによって直接返されない場合、アクセスノードとback-to-originノードのステータスは両方とも**未ヒット**であり、この時点で内容はオリジンサーバーによって返されます。
![](https://main.qcloudimg.com/raw/ce8f450c620a6ed2b13de186a04b677b.png)
 3. この時点で異常なステータス コードが生成された場合、オリジンサーバーのステータスコード、ファイルMD5とアクセスノードモジュールから返されるステータスコード、ファイルMD5を比較することによって、異常がCDNノードか、オリジンサーバーのどちらのせいで発生したか判断し、修復することができます。

>?診断レポートで問題を解決できない場合は、[チケットを提出](https://console.cloud.tencent.com/workorder/category)するか、またはTencent Cloudの技術者にお問い合わせの上、トラブルシューティングを行うことをお勧めします。


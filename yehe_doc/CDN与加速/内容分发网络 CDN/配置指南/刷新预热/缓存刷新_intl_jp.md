## 機能の説明

Content Delivery Network (CDN)は基本的なキャッシュ構成機能を提供しています。サービスタイプやディレクトリ、具体的なURL等各種のルールにより、キャッシュ期限切れ期間を設定することにより、定期的にノードのキャッシュリソースをクリアし、オリジンサーバーが最新のリソースを再度プルしキャッシュする目的を果たします。

また、CDNはキャッシュ更新機能を提供しています。URLまたはディレクトリを一括指定して更新操作を行うことができます：

- URLを更新する：CDNのすべてのノードにおける対応するリソースのキャッシュを削除します。
- ディレクトリの更新：「変更されたリソースの更新」モードを選択すると、ユーザーがマッチングしているディレクトリ配下のリソースにアクセスする時に、back-to-originを行ってリソースのLast-Modify情報を取得します。現在のキャッシュリソースと一致している場合、直接キャッシュされたリソースを戻しますが、一致しない場合は、back-to-originを行って新しいリソースをプルし、再度キャッシュします。「すべてのリソースの更新」モードを選択すると、ユーザーがマッチングしているディレクトリ配下のリソースにアクセスする時に、直接back-to- originを行って新しいリソースをプルしてユーザーに戻し、再度これをキャッシュします。

> ?更新が完了した後、ノード上の対応するリソースには有効なキャッシュがありません。ユーザーがアクセス要求を再度開始すると、ノードは必要なリソースをオリジンサーバーから取得し、ノード上にキャッシュします。このため、大量の更新タスクをサブミットすると、非常に多くのキャッシュがクリアされて、back-to-originリクエストが激増し、オリジンサーバーに大きな負荷がかかります。

## ユースケース

### 新しいリソースのリリース

古いリソースがオリジンサーバー上で同じ名前の新しいリソースによって上書きされた場合、ネットワーク全体のユーザーがノードのキャッシュの影響を受け、古いリソースにアクセスしてしまうことを避けるために、対応するリソースのURL / ディレクトリをサブミットして更新し、ネットワーク全体のキャッシュをクリアにします。これにより、 ネットワーク全体のユーザーがリソースの最新バージョンに直接アクセスすることが可能となります。

### 不正なリソースの削除

オリジンサーバーに不正なリソース（ポルノ、薬物、ギャンブル関係など）が見つかった場合、オリジンサーバーでそれらを削除しても、ノードにキャッシュがあるため、アクセスが可能となります。ネットワーク環境を守るために、URLの更新によってキャッシュされたリソースを削除すれば、不正なリソースのタイムリーな削除を保証できます。

## 操作ガイド



[CDN コンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のディレクトリの**更新やプリフェッチ**をクリックし、ページに入ってから必要に応じて**URL 更新**および**ディレクトリ更新**をサブミット：
- CDN と ECDN ドメイン名のURL / ディレクトリはどちらの形式もサポートしています。
- サブミットは、内容の入力とtxtファイルのアップロードいずれもサポートしています。

![]()


### 内容規範
まず、送信する内容が基準を満たしていることをご確認ください：
- URLに、１行につき１つのプロトコル標識 http:// または https://  が含まれている （例： http://www.test.com/test.html）。
- 終了あるいはロック状態、あるいは現在のアカウントを接続していないドメイン名をサブミットしないようにご注意ください。
- ファイルアップロード時のサブミット形式を選択したら、ファイル形式が txt であり、サイズが10M以内であることをご確認ください。
-  `http://*.test.com/` 形式の URL はサポートされていません。
- 接続先のアクセラレーションドメイン名が汎ドメインであっても、対応するサブドメインをサブミットしてください。
- URL更新に際して、ワイルドカード付きのURLを含むサブミットはサポートされていません。
- URLに中国語が含まれている場合、URL Encodeをオンにして、エンコードしてください。

### サブミット制限
- **URLの更新**：
各アカウントの１日あたりのURL更新制限は10000個までとなります。中国以外でアクセラレーションを有効にしている場合、中国国内の制限と関係なく、中国国外での1日のURL更新制限が10000個となります。
	- 手動で内容を入力するサブミット形式を選択した場合、一回あたりに1000個までサブミット可能です。
	- ファイルのアップロードによるサブミット形式を選択した場合、１回あたりの制限はなく、サブミット回数が直接残り回数から差し引かれます。
>? URL更新量が多く、URL更新の1日の割り当ての残りが少ない（1000未満など）場合、Tencent Cloud CDNは、コンソールによる1日の割り当ての自動ワンクリック追加をサポートします（50,000個に追加するなど）。
>- 割り当ての追加はすぐに有効になりますので、その時点でページを更新し、追加ボタンを頻繁にクリックしないでください。
>- 1度のみの追加をサポートします。例えば、今回、1日の割り当てを50,000まで追加した場合、残りの割り当てが少なくなっても、50,000を超える割り当ての追加はサポートされません。
>- 異なる地域での制限の開放は、互いに独立しています。
- **ディレクトリの更新**：
	各アカウントの１日あたりのディレクトリ更新制限は100個までとなります。中国以外でアクセラレーションを有効にしている場合、中国国内の割り当て量と関係なく、中国国外での1日のディレクトリ更新制限が100個となります。
	- 手動で内容を入力するサブミット形式を選択した場合、一回あたりに20個までサブミット可能です。
	- ファイルのアップロードによるサブミット形式を選択した場合、１回あたりの制限はなく、サブミット回数が直接残り回数から差し引かれます。
	

更新タスクをサブミットするとき、デフォルトではURLのドメイン名の所属するアクセラレーションドメイン名はすべて更新されます。ドメイン名のアクセラレーションエリアがグローバルのとき、中国国内と中国国外どちらの割り当て量も消費されます。
<span ID = "notes"></span>
操作の詳細については、[操作記録](https://intl.cloud.tencent.com/document/product/213/4934)をご参照ください。


### サブユーザー権限の設定

URL更新、ディレクトリ更新及びクエリ更新レコードが権限システムに接続され、リソース（ドメイン名）次元権限構成がサポートされています。詳しくは  [権限構成](https://intl.cloud.tencent.com/document/product/228/35229) をご参照ください。


## ユースケース

### ディレクトリ更新-変更されたリソースを更新する

アクセラレーションドメイン名がpurge-test-1251991073.file.myqcloud.comであり、オリジンサーバーがTencent CloudのCloud Object Storage（COS）です。オリジンサーバーのリソースは下記の通りです：
![]()

１．それぞれリソース1.txt と2.txtのアクセスリクエストを送信し、X-Cache-Lookup: Hit From Distank3およびServer: NWS_SPMid により、ヒットしたノードを判定することができます。ノードより直接リソースを返します：
   ![](https://main.qcloudimg.com/raw/9b307b80e7d1c759bb073eb9f2cf4b6c.png)
   ![](https://main.qcloudimg.com/raw/5fed8bff43d699f47235e5d0db1f2447.png)
2. オリジンサーバーで同名ファイルの1.txtを差し替え、ファイル修正時間が変更されます。2.txtはそのままにします：
   ![](https://main.qcloudimg.com/raw/798fd6a984813aa3a16eaf43856ff7c2.png)
   ![](https://main.qcloudimg.com/raw/bc0d40200fbc744ed34d8552a95c5671.png)
3. この際に、再度リクエストを送信します。キャッシュはまだ期限切れになっていないため、リソース1.txtへのアクセスが古い内容のままです：
![](https://qcloudimg.tencent-cloud.cn/raw/394a84d8f9974ed72cb629b11aac7206.png)
4. ディレクトリ更新をサブミットし、【変更されたリソースを更新する】を選択し、更新が完了するまで待ちます：
   ![]()
5. 更新した後に、ファイル1.txt Last-Modifiedに変更があったため、リクエストはオリジンサーバーに直接転送されます。ファイル2.txtは変更がなかったため、ディレクトリ更新タスクがサブミットされた後でも、ヒットして戻されます：
   ![](https://main.qcloudimg.com/raw/0ea8c1e0e7caac970b3875d4b3987687.png)
   ![](https://main.qcloudimg.com/raw/84e599b1c9c655e62497fb4bdc8e7918.png)

## 概要

TDMQメッセージのバックアップは、Tencent CloudのCloud Object Storage(COS)が[Serverless Cloud Function（SCF）](https://www.tencentcloud.com/document/product/583) をベースとしてユーザーに提供する、TDMQメッセージをCOSにダンプする機能です。ユーザーがTDMQメッセージをダンプすることを支援し、データの分析やダウンロードなどの操作を行いやすくします。

TDMQは、Apache オープンソースプロジェクト [Pulsar ](https://pulsar.apache.org/) をベースとして自社開発された金融グレードの分散型メッセージングミドルウェアで、都市間での高い一貫性、信頼性および同時実行性という特徴を持っています。詳細については、 [TDMQ製品概要](https://intl.cloud.tencent.com/document/product/1110/42904)をご参照ください。

ユーザーが指定したバケットにバックアップ関数ルールを設定すると、TDMQがメッセージを生成する際に、SCFは所定の時間粒度に従ってメッセージを取得し、COSバケットにダンプします。

## 注意事項

- 以前にCOSコンソールでバケットにTDMQメッセージのバックアップルールを追加したことがある場合は、[SCFコンソール](https://console.cloud.tencent.com/scf/list?rid=1&ns=default)で、作成したTDMQメッセージバックアップ関数を確認できます。この関数を削除すると、ルールが有効にならない場合がありますので削除**しないで**ください。
- 現在、COSへのTDMQメッセージのバックアップは、広州、上海、中国香港、北京、成都、シンガポール、シリコンバレーといったリージョンをサポートしています。

## 操作手順

1. [COSコンソール](https://console.cloud.tencent.com/cos5)にログインします。
2. 左側ナビゲーションで**アプリケーション統合 > データバックアップ**をクリックし、**TDMQメッセージのバックアップ**を見つけます。
3. **バックアップルールの設定**をクリックし、ルール設定ページに進みます。
4. **関数の追加**をクリックします。
>! SCFサービスをアクティブ化していない場合は、[SCFコンソール](https://console.cloud.tencent.com/scf)に移動してSCFサービスをアクティブ化し、プロンプトに従ってサービス権限承認を行えば完了です。
>
5. ポップアップしたウィンドウで、以下の情報を設定します。

 - **関数名**：関数の一意の識別名として、作成後に変更することはできません。[SCFコンソール](https://console.cloud.tencent.com/scf/list?rid=1&ns=default)でこの関数を確認できます。
 - **関連バケット**：TDMQメッセージを格納するCOSバケットです。
 - **時間粒度**：メッセージを収集する時間間隔は、メッセージ量のサイズに応じて5～15分の範囲で選択されます。1つのメッセージファイルは最大500MBに制限され、最大で5000個のメッセージを含めることができます。
 - **SCF権限承認**：TDMQメッセージのバックアップには、お客様のTDMQサービスから関連するメッセージを読み取り、お客様が指定したバケットにダンプするための権限承認が必要です。そのため、この権限承認を追加する必要があります。
6. **次のステップ**をクリックし、TDMQ設定を行います。設定項目の説明は次のとおりです。

 - **クラスター選択**：メッセージソースのTDMQクラスターを選択します。同じリージョンのTDMQクラスターのみをサポートしています。
 - **ネームスペース**：クラスター内のネームスペースを選択します。
 - **トピックの選択**：メッセージソースのトピックを選択します。
 - **サブスクリプション選択**：対応するテーマを選択して購読します。現在のサブスクリプションがニーズに適合しない場合は、 [TDMQコンソール](https://console.cloud.tencent.com/tdmq/cluster?rid=1) に進んで新規購読できます。
 - **開始位置**：履歴メッセージの開始位置です。
 - **ロール選択**：TDMQのロールを選択します。TDMQの「ロール」とは、TDMQ独自の概念であり、Tencent Cloudの「ロール」とは異なり、ユーザーがTDMQ内で権限を分割するための最小単位です。ユーザーは複数のロールを追加し、異なるネームスペースに対して生成権限と消費権限を割り当てることができます。
 - **ロールキー**：TDMQのロールキーを選択します。TDMQの「キー」は認証ツールであり、ユーザーはクライアントにキーを追加することで、TDMQにアクセスしてメッセージの生成と消費を行うことができます。キーはロールに逐一対応しており、各ロールには対応する一意のキーがあります。
 - **アクセスアドレス**：VPCプライベートネットワークアクセスアドレスである必要があります。TDMQクラスターはVPCにアクセスする必要があります。詳細については、 [VPC アクセス](https://intl.cloud.tencent.com/document/product/1110/42932)をご参照ください。
>! 対応するVPCサブネットに使用できるIPが必要で、DHCPがサポートされている必要があります。
>
7. **次のステップ**をクリックし、配信の設定を行います。設定項目の説明は次のとおりです。
**配布パス**：バックアップファイルの配布パスのプレフィックスは、入力しないとデフォルトでバケットルートパスに保存されます。指定するプレフィックスは、スラッシュ`/`で終わる必要があります。
8. 設定を追加して**確定**をクリックすると、関数が追加されたことを確認できます。
新規作成した関数に対しては、次のような操作が可能です。
 - **ログ**をクリックして、TDMQメッセージのバックアップ履歴を確認します。バックアップでエラーが発生した場合は、**ログ**をクリックしてSCFコンソールにすばやくジャンプし、ログエラーの詳細を確認することもできます。
 - **その他 > 編集** をクリックして、TDMQメッセージのバックアップルールを変更します。
 - **その他 > 削除**をクリックして、使用しないTDMQメッセージのバックアップルールを削除します。

## 概要

ログクリーンアップは、Tencent CloudのCloud Object Storage（COS）が[Serverless Cloud Function（SCF）](https://www.tencentcloud.com/document/product/583) をベースにしてユーザーに提供するログファイル処理ソリューションです。ユーザーが[ログ管理サービス](https://intl.cloud.tencent.com/document/product/436/16920) を有効にするか、ログファイルをご自身でアップロードすると、COSによりあらかじめ設定されたSCFが自動的にトリガーされます。関数であらかじめ指定したSQL検索ステートメントによって、ファイル内のログ情報は自動的にフィルタリングしてクリーンアップされ、その結果は指定したバケットとそのパスに配布されます。

## 注意事項

- ログクリーンアップ機能は、COSデータ検索インターフェースを使用します。制限に関する説明については、[Selectの概要](https://intl.cloud.tencent.com/document/product/436/32472)をご参照ください。
- 以前にCOSコンソールでバケットにログクリーンアップルールを追加したことがある場合は、[SCFコンソール](https://console.cloud.tencent.com/scf/list?rid=1&ns=default)で、作成したCDNログクリーンアップ関数を確認できます。このログクリーンアップ関数を削除または変更すると、ルールが有効にならない場合がありますので削除**しないで**ください。
-現在、ログクリーンアップ機能は、広州、上海、北京、成都でのみサポートされています。
- COSログクリーンアップ機能は、SCFサービスに依存しており、ユーザーには[無料利用枠](https://intl.cloud.tencent.com/document/product/583/12282)が提供されていますが、無料利用枠を超える部分については、[SCF製品価格](https://intl.cloud.tencent.com/document/product/583/12281)に従って課金されます。

## 操作手順

1. [COSコンソール](https://console.cloud.tencent.com/cos5)にログインします。
2. 左側ナビゲーションで**アプリケーション統合 > 拡張機能**をクリックし、**ログクリーンアップ**を見つけます。
3. **ログクリーンアップルールの設定**をクリックし、ルール設定ページに進みます。
4. **関数の追加**をクリックします。
>! SCFサービスをアクティブ化していない場合は、[SCFコンソール](https://console.cloud.tencent.com/scf)に移動してSCFサービスをアクティブ化し、プロンプトに従ってサービス権限承認を行えば完了です。
> 
5. ポップアップしたウィンドウで、以下の情報を設定します。

	- **関数名**：関数の一意の識別名として、作成後に変更することはできません。[SCFコンソール](https://console.cloud.tencent.com/scf/list?rid=1&ns=default)でこの関数を確認できます。
	- **関連バケット**：ログを保存するCOSバケットです。
	- **イベントタイプ**：イベントとは、SCFをトリガーする操作のことです。アップロード操作を例にとると、アップロード方法は、`PUT Object`インターフェースか`POST Object`インターフェースを呼び出して行われます。選択したイベントが**Putメソッドによって作成**された場合、`PUT Object`インターフェースからアップロードされたログファイルのみがログクリーンアップをトリガーします。
>! ファイルが、シンプルアップロード、マルチパートアップロード、クロスリージョンレプリケーションなど、複数のチャネルでバケットにアップロードされる場合は、**すべて作成**イベントの選択をお勧めします。
>
	- **トリガー条件**：ログファイルのアップロード時にSCFをトリガーするパスのことです。指定された範囲を選択した場合、ログファイルが指定された範囲のパスにアップロードされたときにのみSCFをトリガーします。バケット全体を選択した場合、ログファイルがバケットの任意の場所にアップロードされたときにトリガーされます。
	- **SCF権限承認**：ログクリーンアップには、SCFがバケットからログファイルを読み取り、クリーンアップしたログファイルを指定した場所にアップロードするための承認が必要です。そのため、この権限を追加する必要があります。
6. **次のステップ**をクリックし、ログクリーンアップの設定を行います。設定項目の説明は次のとおりです。

	- **ソースファイルの設定**：実際の状況に応じて、検索したいファイルタイプ、行/列の区切り、リストヘッダー、圧縮形式を選択します。
	**SQL表現**：検索したいステートメントを入力します。当社が提供するSQLテンプレートを選択することもできます。SQL関連のコマンドの説明については、[SQL関数](https://intl.cloud.tencent.com/document/product/436/32474)をご参照ください。
	- **エクスポート設定**：実際の状況に応じて、エクスポート形式、行/列の区切り文字およびエスケープ設定を選択することができます。
7. **次のステップ**をクリックし、配信の設定を行います。設定項目の説明は次のとおりです。

	- **配布バケット**：ログファイルのクリーンアップが完了した後、生成されたファイルをストレージする必要があるバケットです。
	- **配布パス**：ログファイルのクリーンアップが完了した後、生成されたファイルを保存する必要がある特定のパスです。循環トリガーを避けるために、配布パスのプレフィックスは、トリガー条件と異なるものを指定することをお勧めします。
>! 設定した配布プレフィックスとトリガー条件プレフィックスの間に包含関係がある場合、循環トリガーが発生する可能性がありますので、これを可能な限り避けるようにしてください。例えば、配布プレフィックスがprefix/target/、トリガー条件プレフィックスがprefix/で、prefix/test.csvのログファイルをアップロードする場合、ログクリーンアップ生成物であるprefix/target/test.cos_select_result.csvが自動的に生成されてバケットに配布され、これにより循環クリーンアップがトリガーされます。
> 
8. 設定を追加して**確定**をクリックすると、関数が追加されたことを確認できます。
新規作成した関数に対しては、次のような操作が可能です。
 - **ログ**をクリックして、ログクリーンアップの履歴を確認します。ログクリーンアップでエラーが発生した場合は、**ログ**をクリックしてSCFコンソールにすばやくジャンプし、ログエラーの詳細を確認することもできます。
 - **その他 > 編集**をクリックして、ログクリーンアップルールを変更します。
 - **その他 > 削除**をクリックし、使用しないログクリーンアップルールを削除します。


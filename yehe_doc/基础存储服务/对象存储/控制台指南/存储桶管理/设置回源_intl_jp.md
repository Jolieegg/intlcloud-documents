## 概要

Cloud Object Storage（COS）コンソールを使用して、バケットのback-to-originルールを設定することができます。リクエストしたオブジェクトがバケットに存在しない場合、または特定のリクエストをリダイレクトする必要がある場合は、back-to-originルールを使用して、COSから対応するデータにアクセスすることができます。back-to-originの設定は、主にデータのホットマイグレーションや特定リクエストのリダイレクトなどのシナリオに使用され、実際の必要性に応じて設定することができます。

>?
>- back-to-originによるデータプルの成功率はネットワーク環境に依存するため、チャイナテレコム、チャイナモバイル、チャイナユニコムなどのIPセグメントを優先的に使用してください。
>

<img src="https://main.qcloudimg.com/raw/f63a74cf70a9f6582e52e13a2b16e72a.png" width="90%">

## back-to-originルール

### トリガー条件

- 非同期back-to-originおよび同期back-to-originモードでは、リクエストが404を返した場合のみback-to-originをトリガーします。
- リダイレクトモードでは、ユーザーは400～599のHTTPステータスコードをカスタマイズしてback-to-originをトリガーすることができます。

### オリジンサーバーにアクセスする

- 非同期back-to-originおよび同期back-to-originモードでは、COSにアクセスするQueryStringおよびHeader情報をオリジンサーバーにパススルーするかどうか、オリジンサーバーへのリクエストを追加する時に追加のHeader情報を付加するかどうかを設定できます。リダイレクトモードはQueryStringがパススルーするかどうかの設定のみをサポートしています。
- GET操作時にGET rangeを指定した場合、COSは元のリクエスト以外にさらにrangeなしの非同期リクエストを送信し、完全なオブジェクトデータを取得してCOSに保存します。

### 応答と保存

- オリジンサーバーはchunkedエンコードでデータを返すことをサポートしています。
- オリジンサーバーが404ステータスコードを返した場合、COSにパススルーしてユーザーに返します。**3XX追従ポリシー**を有効化した場合、オリジンサーバーが3XXステータスコードを返した時に別のオリジンサーバーにおいてデータをプルします。オリジンサーバーが、その他の2XXではないステータスコードを返した場合、COSは424を返します。
- back-to-originが返すファイルはオリジンサーバーをリクエストする時に使用するファイル名でCOSに保存されます。例えばあるユーザーがリクエストするファイルexample.jpgがバケットに存在しない場合、COSはback-to-originメカニズムをトリガーしてユーザーが設定したback-to-originアドレス `http://origin.com/example.jpg` においてファイルをプルし、バケットに保存するファイルをexample.jpgと命名します。
- COSに保存される新しいオブジェクトには、以下のメタデータが含まれます。データの内容はオリジンサーバーの値に追従します。
```shell
cache-control
content-disposition
content-encoding
content-type
expires
x-cos-meta-*
```


## 操作手順

1. [COSコンソール](https://console.cloud.tencent.com/cos5)にログインします。
2. 左側ナビゲーションバーで**バケットリスト**をクリックし、バケットリストページに進みます。
3. back-to-originを設定したいバケットをクリックし、バケット詳細ページに進みます。
4. 左側ナビゲーションバーで、**基本設定 > back-to-originの設定**をクリックし、**back-to-originリストの追加**をクリックします。
![](https://main.qcloudimg.com/raw/69fc0f3042e59c3e9c2667d06aa068fa.png)
5. ポップアップウィンドウに以下の情報を設定し、**次のステップ**をクリックします。

 - **back-to-originモード**：実際のニーズに応じてback-to-originモードを選択できます。
    - **非同期back-to-origin**：COSで検索するようにリクエストされたファイルが存在しない場合、COSは指定のオリジンサーバーからファイルを検索し、そのファイルをバケットにアップロードしますが、ユーザー側には返しません。
    >?非同期back-to-originは直接ファイルを返さず、まず302をクライアントに返し、さらに非同期でファイルをCOSにアップロードします。
    >1. クライアントでFollow 302を有効化し、オリジンサーバーからデータをプルすることをお勧めします。
    >2. ファイルのアップロード時間は複数の要因の影響を受け、SLAを承諾できません。**適時性を必要とするユーザーがback-to-originの同期を選択することをお勧めします**。
    - **同期back-to-origin**：COSで検索するようにリクエストされたファイルが存在しない場合、COSは指定のオリジンサーバーからファイルを検索し、そのファイルをユーザー側に返してバケットにアップロードします。
    - **リダイレクト**：バケットへのアクセスをリクエストした時に特定のエラーが発生した場合、COSはリダイレクトアドレスをユーザー側に返し、オリジンサーバーのファイルを保存します。ユーザー側はリダイレクトアドレスによって、オリジンサーバーにリソースへのアクセスをリクエストします。
 -  **back-to-origin条件**：ニーズに応じてback-to-originをトリガーする条件を選択することができます。back-to-originをトリガーするには、設定したすべてのback-to-origin条件が同時に満たされている必要があります。
    - **HTTPステータスコード 404**：非同期back-to-originまたは同期back-to-originを選択した場合は、 HTTPステータスコードが404の時にback-to-originをトリガーします。この項目は入力必須で、キャンセルすることはできません。リダイレクトback-to-originモードを選択した場合、400～599のHTTPステータスコードを入力できます。
    - **ファイル名プレフィックス**：リクエストされたファイル名のプレフィックスマッチングを行う際、back-to-originルールがトリガーされます。例えば、ファイル名プレフィックスをprefixに設定してから、 `https://examplebucket-1250000000.cos.ap-chengdu.myqcloud.com/prefix123.jpg`にアクセスすると、返されるHTTPステータスコードが404であれば、back-to-originルールがトリガーされます。
 - **back-to-originプロトコル**：COSがお客様が指定したオリジンサーバーにアクセスする際に使用するHTTPプロトコルで、HTTPSの強制、HTTPの強制およびリクエストプロトコルのフォローというオプションがあります。
    - HTTPS/HTTPの強制を選択した場合、COSはHTTPS/HTTPプロトコルを使用してオリジンサーバーにアクセスします。
    - リクエストプロトコルのフォローを選択すると、COSは、お客様がCOSにリクエストしたプロトコルでオリジンサーバーにアクセスします。
 - **リクエストパラメータ**：COSにアクセスする際に付加されるqueryStringリクエストパラメータをオリジンサーバーに透過的に送信するかどうかです。
 - **透過的に指定されたリクエストヘッダー**：ここでは、オリジンサーバーに透過的に送信したいヘッダー情報を追加することができます。リダイレクトback-to-originのタイプを選択した場合は、この項目は設定されません。
 - **リクエストヘッダーの追加**：ここでは、オリジンサーバーにback-to-originするときに付加するリクエストヘッダーを追加することができます。リダイレクトback-to-originのタイプを選択した場合は、この項目は設定されません。
6. 選択したback-to-originモードに応じて、以下の情報を選択して設定し、**次のステップ**をクリックします。

<dx-tabs>
::: back-to-originの非同期

 - **back-to-originアドレス**：ドメイン名またはIPアドレスを入力するだけで、ドメイン名またはIPアドレスの後にポート番号を追加できます。プレフィックス`http://`または`https://`を付ける必要はありません。
正しいアドレスの例は次のとおりです。

```shell
abc.example.com
abc.example.com:8080
202.96.128.86
202.96.128.86:8080
```

 - **back-to-アドレスのバックアップ**：ドメイン名またはIPアドレスをサポートしています。具体的なアドレスの設定をサポートしています。次のような項目を設定することができます。
    - **固定ファイル**：back-to-originルールがトリガーされると、デフォルトですべてが固定されたファイルにジャンプします。
    - **指定プレフィックス**：back-to-originルールがトリガーされると、指定されたプレフィックスを持つファイルにジャンプします。例えば、指定されたプレフィックスが`test`の場合、`https://examplebucket-1250000000.cos.ap-chengdu.myqcloud.com/prefix123.jpg`にアクセスした際にback-to-originルールがトリガーされ、`<back-to-originアドレス>/test/prefix123.jpg`にジャンプします。
    - **指定拡張子**：back-to-originルールがトリガーされると、指定された拡張子を持つファイルにジャンプします。例えば、指定された拡張子が`.jpg`の場合、`https://examplebucket-1250000000.cos.ap-chengdu.myqcloud.com/prefix123`にアクセスした際にback-to-originルールがトリガーされ、`<back-to-originアドレス>prefix123.jpg`にジャンプします。

<b>Note:</b>
         - 固定ファイルを選択した場合、他の2種類のタイプはデフォルトでは選択できません。
         - 指定されたプレフィックスと指定された拡張子の設定を同時に有効にすることができます。

 - **3xxフォローポリシー**：有効にすると、オリジンサーバーが3XXリダイレクトステータスコードを返す場合、COSのデフォルトの処理ポリシーは3XXに従って、別のオリジンサーバーからデータを再度プルすることになります。**無効**を選択してもリソースはプルされません。
:::
::: back-to-originの同期

 - **back-to-originアドレス**：ドメイン名またはIPアドレスを入力するだけで、ドメイン名またはIPアドレスの後にポート番号を追加できます。プレフィックス`http://`または`https://`を付ける必要はありません。
正しいアドレスの例は次のとおりです。

```shell
abc.example.com
abc.example.com:8080
202.96.128.86
202.96.128.86:8080
```

 - **back-to-アドレスのバックアップ**：ドメイン名またはIPアドレスをサポートしています。具体的なアドレスの設定をサポートしています。次のような項目を設定することができます。
    - **固定ファイル**：back-to-originルールがトリガーされると、デフォルトですべてが固定されたファイルにジャンプします。
    - **指定プレフィックス**：back-to-originルールがトリガーされると、指定されたプレフィックスを持つファイルにジャンプします。例えば、指定されたプレフィックスが`test`の場合、`https://examplebucket-1250000000.cos.ap-chengdu.myqcloud.com/prefix123.jpg`にアクセスした際にback-to-originルールがトリガーされ、`<back-to-originアドレス>/test/prefix123.jpg`にジャンプします。
    - **指定拡張子**：back-to-originルールがトリガーされると、指定された拡張子を持つファイルにジャンプします。例えば、指定された拡張子が`.jpg`の場合、`https://examplebucket-1250000000.cos.ap-chengdu.myqcloud.com/prefix123`にアクセスした際にback-to-originルールがトリガーされ、`<back-to-originアドレス>prefix123.jpg`にジャンプします。
<b>Note:</b>
         - 固定ファイルを選択した場合、他の2種類のタイプはデフォルトでは選択できません。
         - 指定されたプレフィックスと指定された拡張子の設定を同時に有効にすることができます。

 - **3xxフォローポリシー**：有効にすると、オリジンサーバーが3XXリダイレクトステータスコードを返す場合、COSのデフォルトの処理ポリシーは3XXに従って、別のオリジンサーバーからデータを再度プルすることになります。**無効**を選択してもリソースはプルされません。
 - **オリジンサーバーへのリターンパケット**：この機能を有効化すると、オリジンサーバーに、ステータスコードなどの情報を含むリターンパケットを直接返すことができます。
:::
::: リダイレクト

 - **back-to-originアドレス**：ドメイン名またはIPアドレスを入力するだけで、ドメイン名またはIPアドレスの後にポート番号を追加できます。プレフィックス`http://`または`https://`を付ける必要はありません。
正しいアドレスの例は次のとおりです。

```shell
abc.example.com
abc.example.com:8080
202.96.128.86
202.96.128.86:8080
```

 - **back-to-アドレスのバックアップ**：ドメイン名またはIPアドレスをサポートしています。具体的なアドレスの設定をサポートしています。次のような項目を設定することができます。
    - **固定ファイル**：back-to-originルールがトリガーされると、デフォルトですべてが固定されたファイルにジャンプします。
    - **指定プレフィックス**：back-to-originルールがトリガーされると、指定されたプレフィックスを持つファイルにジャンプします。例えば、指定されたプレフィックスが`test`の場合、`https://examplebucket-1250000000.cos.ap-chengdu.myqcloud.com/prefix123.jpg`にアクセスした際にback-to-originルールがトリガーされ、`<back-to-originアドレス>/test/prefix123.jpg`にジャンプします。
    - **指定拡張子**：back-to-originルールがトリガーされると、指定された拡張子を持つファイルにジャンプします。例えば、指定された拡張子が`.jpg`の場合、`https://examplebucket-1250000000.cos.ap-chengdu.myqcloud.com/prefix123`にアクセスした際にback-to-originルールがトリガーされ、`<back-to-originアドレス>prefix123.jpg`にジャンプします。
<b>Note:</b>
         - 固定ファイルを選択した場合、他の2種類のタイプはデフォルトでは選択できません。
         - 指定されたプレフィックスと指定された拡張子の設定を同時に有効にすることができます。

 - **リダイレクトCode**：301、302、307が選択できます。デフォルトは 301です。
:::
</dx-tabs>

7. 設定したback-to-originルールが正しいことを確認し、**OK**をクリックします。
ルールを追加すると、システムは新しいルールに最高の優先度を割り当てます。COSは、最高の優先度のルールに従ってback-to-originを行います。また、ルールリストページの変更ボタンをクリックして、優先順位を調整することもできます。
![](https://main.qcloudimg.com/raw/3fa148b2e43f30fb891adee75ff255db.png)


## 事例

**背景**
APPIDは、1250000000のユーザー用に、 examplebucket-1250000000という名前のバケットを作成し、ドメイン名へのCDNアクセラレーションアクセスを有効にします。

```shell
examplebucket-1250000000.file.myqcloud.com
```

バケットのback-to-originアドレスを、次のように設定します。

```shell
abc.example.com
```

オリジンサーバー`http://abc.example.com`に画像picture.jpgを保存します。

**クライアントの初回アクセス（back-to-originの同期が有効でない場合）**：

```shell
http://examplebucket-1250000000.file.myqcloud.com/picture.jpg
```

COSは、オブジェクトをヒットできなかったと判断すると、クライアントにHTTPステータスコード302を返し、以下のアドレスにジャンプします。

```shell
http://abc.example.com/picture.jpg
```

**クライアントの初回アクセス（back-to-originの同期が有効である場合）**：

```shell
http://examplebucket-1250000000.file.myqcloud.com/picture.jpg
```

COSは、オブジェクトをヒットできなかったと判断すると、クライアントにHTTPステータスコード200を返し、以下のアドレスにジャンプします。

```shell
http://abc.example.com/picture.jpg
```

この時点で、オブジェクトはオリジンサーバーからクライアントに提供され、アクセスが保証されます。同時にCOSは、オリジンサーバーからpicture.jpgをコピーし、バケットexampleのルートディレクトリに保存します。

**2回目のアクセス**：

```shell
http://examplebucket-1250000000.file.myqcloud.com/picture.jpg
```

COSは、ルートディレクトリのpicture.jpgオブジェクトに直接アクセスし、それをクライアントに返します。


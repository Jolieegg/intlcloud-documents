## 概要

Cloud Object Storage（COS）はオブジェクトベースのライフサイクル設定をサポートしています。これはバケットに対して指定の記述言語を送信することで、ルールに該当するオブジェクトに、指定の条件下でいくつかのアクションを自動的に実行させることができるものです。

>?各バケットに追加できるライフサイクルルールは1000個までです。

## ユースケース

### ログの記録

ユーザーがCOSを使用してログデータを保存している場合は、ライフサイクルの設定によって、ログデータを30日後に自動的にアーカイブしたり、2年後に自動的に削除したりすることができます。

### コールドデータとホットデータの階層分離

ホットデータはアップロード後、短時間のうちに大量にアクセスされ注目度が高まりますが、一定期間が過ぎると注目度が徐々に低下したり、リアルタイムでのアクセスが必要なくなったりします。ライフサイクルルールによって、30日前のデータを低頻度ストレージに切り替えることや、さらに60日前のデータをアーカイブストレージに切り替えることができます。このプロセスはデータの移行と呼ばれます。

### アーカイブ管理

COSを使用してファイルアーカイブを管理する際、しばしば金融、医療などのコンプライアンス要件に基づき、ファイルのすべての過去バージョンを長期保存する必要が生じます。このような場合、ライフサイクル機能を使用することで、過去バージョンのファイルをアーカイブに移行するアクションを実行できます。

## 設定の要素
ライフサイクルルールを作成する際は、次の要素を設定する必要があります。

### リソース
ライフサイクルの実行時にヒットするデータを指定します。カスタムライフサイクルの適用範囲および範囲内でカバーされるデータタイプを指定できます。ライフサイクルの実行時にはユーザーが指定する適用範囲をスキャンし、範囲内のユーザーが設定したデータタイプに対してアクションを実行します。このうち、適用範囲は以下のルールに従って指定することができます。
- プレフィックスによる指定：ディレクトリのプレフィックスまたはファイル名のプレフィックスによるマッチングをサポートしています。
- タグによる指定：オブジェクトタグによってデータをフィルタリングします。

設定可能なデータタイプには次のものがあります。
- 現在のバージョンのファイル：バケット内の最新バージョンのオブジェクト。
- 過去のバージョンのファイル：バージョン管理を有効化した後に保存した過去のバージョンのオブジェクト。バージョン管理に関するその他の情報については、[バージョン管理の概要](https://intl.cloud.tencent.com/document/product/436/19883)をご参照ください。
- 削除マーカー：「オブジェクトが削除済みであることを表すマーカー」であり、ライフサイクルでは過去のバージョンがすべて削除された後、このマーカーを自動的に除去します。削除マーカーに関するその他の説明については、[削除マーカードキュメント](https://intl.cloud.tencent.com/document/product/436/36716)をご参照ください。
- フラグメントファイル：マルチパートアップロードタスクが完了していない場合に発生するフラグメント。


### 操作
オブジェクトにヒットした際に実行する操作を指定します。
- データ移行：作成したオブジェクトを、指定の時間以降、低頻度ストレージ、INTELLIGENT_TIERINGストレージ、アーカイブストレージ、ディープアーカイブストレージタイプに移行します。
- 期限切れの削除：オブジェクトの有効期限を設定し、オブジェクトが期限切れとなった後に自動的に削除します。


### 時間条件
上記の操作をトリガーする時間条件を指定します。
日数に基づく計算：ルールに対応する動作を、オブジェクトの最終変更日から何日後に実行するかを明確に指定します。

## 利用説明

>?ライフサイクルの使用方法に関しては、[ライフサイクルの設定](https://intl.cloud.tencent.com/document/product/436/17031)をご参照ください。

### ルール時刻の説明

#### ファイル変更時刻
ライフサイクルはオブジェクトの変更時刻に基づいてルールをトリガーし、実行することができます。ファイルに対して書き込み操作を行う、[PUT Object](https://intl.cloud.tencent.com/document/product/436/7749)、[PUT Object - Copy](https://intl.cloud.tencent.com/document/product/436/10881)、[POST Object](https://intl.cloud.tencent.com/document/product/436/14690)、[Complete Multipart Upload](https://intl.cloud.tencent.com/document/product/436/7742)などのインターフェースだけはオブジェクトの変更時刻を更新しますが、ライフサイクルによるオブジェクトの移行では変更時刻は更新されません。

#### 実行日数の説明
ルールで設定する日数は24時間に準じます。24時間未満は1日として数えません。

例えば、1日の午後3時に、ファイルを変更から1日後に削除するというライフサイクルルールを設定したとします。その場合、ライフサイクルタスクは2日0時から、2日0時以前の時点で最終変更時刻から1日以上過ぎているファイルのスキャンを開始し、削除タスクを実行します。1日当日にアップロードしたファイルは、最終変更時刻から1日経っていないため削除されず、3日0時になってからスキャンと記録が行われ、削除が実行されます。

#### ルール日数の上限
ライフサイクルの設定は最長3650日までサポートしています。

#### 有効時間
ライフサイクルは日次スキャンと実行という2つの操作によって有効になります。
 - スキャン：COSは現地時間（GMT+8）每日0時にライフサイクルルールをプルします。スキャンは適用範囲のすべてのオブジェクトにヒットします。
 - 実行：オブジェクトがルールで指定した日付に達したことがスキャンされた場合は、移行または削除操作を実行します。

例えば、あるユーザーが2023年1月20日にルールAを設定し、test.txtを変更時刻から10日後に削除するよう指定したとします。この場合、2023年1月21日0時から、毎日0時にtest.txtの変更時刻をスキャンします。このファイルの最終変更時刻が2023年1月15日の場合、2023年1月26日0時に行ったスキャンタスクによってこのファイルが削除条件を満たしていると判断されると、スキャン完了後に削除操作を実行します。

> ! ルールスキャンおよび実行期間中にルールの状態を変更しないでください。変更すると元のルールが終了するため、移行または削除操作の正確な実行が保証されなくなります。


### データ移行



#### 単方向性の原則
データ移行は単方向性であり、標準ストレージ > 低頻度ストレージ > INTELLIGENT_TIERINGストレージ > アーカイブストレージ > ディープアーカイブストレージの順序のみ許容されます。階層をスキップしての移行（標準ストレージ > アーカイブストレージ）も可能ですが、逆方向への移行はできません。[PUT Object - Copy](https://intl.cloud.tencent.com/document/product/436/10881)（アーカイブストレージ/ディープアーカイブストレージタイプ以外）、または[POST Object restore ](https://intl.cloud.tencent.com/document/product/436/12633)（アーカイブストレージ/ディープアーカイブストレージタイプにのみ適用）を呼び出すことでのみ、コールドストレージタイプのデータをホットストレージタイプに復元することができます。

#### 最終的な整合性
同一グループのオブジェクトに複数のルールを設定していて、競合が生じている場合（期限切れ削除設定は含まない）、COSは**最もコールドなストレージタイプへの移行**ルールを優先的に実行します。

例えば、ルールAがファイル変更から90日後に**低頻度ストレージに移行**するよう設定し、ルールBがファイル変更から90日後に**アーカイブストレージに移行**するよう設定しており、かつ上記のルールがどちらも同一のオブジェクトtest.txtにヒットしている場合、ルールBが優先的に実行されます。

|ルール|リソース|操作|時間条件|実行状況|
|----|----|----|----|----|
|ルールA | test.txt |低頻度ストレージに移行|ファイル変更時刻から90日|ルール競合により実行失敗|
|ルールB | test.txt |アーカイブストレージに移行|ファイル変更時刻から90日|実行成功|

>! 
>- Tencent Cloud COSでは、同一グループのオブジェクトに対し、複数の競合条件を含むライフサイクルルールを設定しないよう強く注意喚起しています。競合がある状態で実行すると、料金が変わる可能性があります。
>- データの移行によってオブジェクトの元のアップロードまたは変更時刻が変更されることはありません。
>

### 期限切れの削除

#### 処理ロジック
オブジェクトが指定された期限切れ削除のライフサイクルルールにマッチした場合、Tencent Cloudはオブジェクトを非同期の削除キューに追加します。実際に削除される時間は作成時間から一定程度遅延する場合があります。GETまたはHEAD Object操作によってオブジェクトの現在のステータスを取得することができます。

#### 最終的な整合性
同一グループのオブジェクトに複数のルールを設定していて、競合が生じている場合、COSは最短の有効期限に準じて実行します。また、**期限切れ削除の実行エフェクトはストレージタイプの切り替えより強いものになります**。

例えば、ルールCがファイル変更から180日後に**低頻度ストレージに移行**するよう設定し、ルールDがファイル変更から180日後に**オブジェクトを削除**するよう設定しており、かつ上記のルールがどちらも同一のオブジェクトtest.txtにヒットしている場合、ルールDが優先的に実行されます。

|ルール|リソース|操作|時間条件|実行状況|
|----|----|----|----|----|
|ルールC | test.txt |低頻度ストレージに移行|ファイル変更時刻から180日|ルール競合により実行失敗|
|ルールD | test.txt |オブジェクトを削除|ファイル変更時刻から180日|実行成功|


>! Tencent Cloud COSでは、同一グループのオブジェクトに対し、複数の競合条件を含むライフサイクルルールを設定しないよう強く注意喚起しています。競合がある状態で実行すると、料金が変わる可能性があります。
>


### コストの注意点

#### 実行の説明

 - ライフサイクルが削除操作を実行する際には、バックエンド削除リクエストが発生します。移行操作を実行する際には、バックエンド削除リクエストと書き込みリクエストが発生します。上記の操作で発生するリクエストの回数は、リクエスト料金が発生した請求書に計上されます。例えば、標準ストレージタイプのファイル `test.txt` をライフサイクルで低頻度ストレージに移行すると、標準ストレージデータ削除と低頻度ストレージデータ書き込みの2回のリクエストが発生します。

 - ライフサイクル実行のエフェクトには予期しない状況や、バケットに大量の既存オブジェクトが含まれる状況は含まれません。他の状況が原因で完了していない場合は、GETまたはHEAD Object操作によってオブジェクトの現在のステータスを取得することができます。
 - 現在Tencent Cloudはライフサイクルの実行エフェクトについて請求書の承諾をご提供していません。すなわち、オブジェクトの料金はライフサイクルの実行が完了した時点で変更されます。

#### 時間に対するあいまいさ

 - 低頻度ストレージとINTELLIGENT_TIERINGストレージタイプは30日以上、アーカイブストレージタイプは90日以上、ディープアーカイブストレージタイプは180日以上の保存期間がそれぞれ必要であることにご注意ください。データ移行または削除を実行する際に追加のストレージ料金は発生しません。Tencent Cloud COSは30/90/180日未満のライフサイクル設定をチェックしないため、正しい設定をお客様ご自身の必要性に応じて実行する必要があります。

 - 例えば、ある低頻度ストレージのオブジェクトについて、保存期間が30日に達する前に移行が実行された場合、これによってその当日にオブジェクトのアーカイブストレージタイプ料金が発生すると同時に、低頻度ストレージの料金も30日目まで引き続きかかります。あるアーカイブストレージオブジェクトについて、保存期間が90日に達する前に削除が実行された場合、そのオブジェクトのアーカイブストレージタイプ料金は90日目まで継続して課金されます。データがディープアーカイブストレージに移行された場合も同様です。

- #### サイズ制限
低頻度ストレージ、アーカイブストレージおよびディープアーカイブストレージにはそれぞれ、オブジェクトの最小占有容量の制限が設けられています。例えば、低頻度ストレージに64KB未満のファイルをアップロードした場合は、64KBとして計算されます。ユーザーコストを抑えるため、ライフサイクルは64KB未満のオブジェクトに対してはストレージタイプ切り替えの操作を実行しません。 

>? ライフサイクルは64KB未満のオブジェクトに対しては切り替え操作を実行しません。


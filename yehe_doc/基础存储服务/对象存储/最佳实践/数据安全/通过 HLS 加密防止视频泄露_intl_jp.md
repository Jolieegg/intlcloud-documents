## 概要

Cloud Object Storage（COS）のデータ処理はHLSビデオコンテンツに対する暗号化機能を提供します。暗号化されたビデオは、アクセス権限のないユーザーの視聴用に配信できなくなります。HLS暗号化は業務側のキーサービスおよびToken発行サービスの構築プロセスに関連するため、この方法は主に、完全な認証およびキー管理サービス（KMS）を自ら構築できる業務側に適しています。

>! 現在はHLS標準暗号化のみサポートしています。
>

## 実装の原理

![](https://qcloudimg.tencent-cloud.cn/raw/fe49915c6d9de74677b6ef4f03ac5158.jpg)

>? この暗号化方式では、COSはTencent Cloud KMSサービスに接続します。
>

### 暗号化フロー

1. ユーザー業務側がビデオをCOSにアップロードした後、HLS暗号化をリクエストします。
2. COSは暗号化リクエストを受信した後、KMSに暗号化鍵をリクエストします。
3. COSはトランスコード機能によってビデオのHLS暗号化を行います。
4. 暗号化後、COSはCDNを通じて暗号化されたHLSビデオファイルを配信します。

### 復号フロー

1. 端末ユーザーがプレーヤー端末にログインすると、ユーザー業務側が端末ユーザーのID認証を行い、認証に成功後、再生端末にTokenを割り当て、Token付きの再生アドレスをプレーヤー側に返します。
2. ユーザーの再生端末が解析して返すm3u8ファイルが「URI」の内容を取得し、URIにキーをリクエストします。
3. ユーザー業務側のリスク管理サービスはリクエストを受信すると、まずユーザーのロジックに基づいて自ら適格性を判断した後、KMSサービスのAPIを呼び出してキーを照会します。
4. KMSは返されたキーを再生端末に返します。再生端末は取得したキーペアでm3u8ファイルを復号し、再生を行います。

## 暗号化の操作手順

1. [COSコンソール](https://console.cloud.tencent.com/cos5)にログインします。
2. 左側ナビゲーションバーで**バケットリスト**をクリックし、バケットリスト管理ページに進みます。
3. ビデオを保存したいバケットを見つけ、そのバケット名をクリックし、バケット管理ページに進みます。
4. 左側ナビゲーションバーで、**データワークフロー > 共通設定 > テンプレート**をクリックし、テンプレート設定ページに進みます。
5. **オーディオビデオトランスコード**を選択し、**トランスコードテンプレートの作成**をクリックすると、トランスコードテンプレート作成ウィンドウがポップアップします。
6. トランスコードテンプレート作成ウィンドウで、以下の情報を設定します。

 - テンプレート名：長さは64文字以下とし、中国語、英語、数字、アンダーバー「_」、ハイフン「-」、「*」のみサポートします。
 - コンテナ形式：HLSを選択します。
 - トランスコード時間：ソースファイル時間、カスタム設定から選択できます。
 - 高度な設定： 
    - ビデオ暗号化：ビデオ暗号化を有効にします。
    - UriKey：ユーザーが構築したKMSのアドレスです。
7. **OK**をクリックし、暗号化テンプレートの設定を完了します。その後、このテンプレートを使用して[ワークフローの設定](https://intl.cloud.tencent.com/document/product/436/46408)および[タスクの設定](https://intl.cloud.tencent.com/document/product/436/46409)を行うことでビデオを暗号化できます。

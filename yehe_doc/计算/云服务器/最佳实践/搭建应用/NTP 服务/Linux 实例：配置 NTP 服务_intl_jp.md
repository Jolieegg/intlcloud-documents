## 操作シナオリ

Network Time Protocol daemon (NTPD) は Linux OSのデーモンプロセスであり、ローカルシステムとクロックソースサーバ間の時間差を修正するために使用され、NTP プロトコルを完全に実現します。NTPDとNTPDateの違いは、NTPDateは強制的に即時更新するために使用でき、NTPDは体系的な方法として使用できます。このドキュメントでは、CentOS 7.5 OSのCVMを例として使用して、NTPDをインストールおよび設定する方法について説明します。

## 注意事項

- 一部のOSでは、デフォルトのNTPサービスとしてchronyを使用しています。NTPDが実行中であり、起動時に自動的に起動するように設定されていることを確認してください。
 - `systemctl is-active ntpd.service`コマンドを使用して、NTPDが実行されているかどうかを確認します。
 - `systemctl is-enabled ntpd.service`コマンドを使用して、NTPDが起動時に自動的に起動するように設定されているかどうかを確認します。
- NTPサービスの通信ポートはUDP 123です。NTPサービスを設定する前に、UDP 123ポートをインターネットに開放することを確認してください。
このポートが開放されていない場合、[セキュリティグループルールの追加](https://intl.cloud.tencent.com/document/product/213/34272)を参照して、ポートをインターネットに開放してください。

## 操作手順

### NTPDサービスのインストール

次のコマンドを実行して、NTPDがインストールされているかどうかを確認します。
```
rpm -qa | grep ntp
```
 - 次の結果が返される場合、NTPDがインストールされていることを意味します。
![ntpdがインストールされているかを確認する](https://main.qcloudimg.com/raw/34073904c49e80ab61da25559c7239e5.png)
 - NTPDがインストールされていない場合は、`yum install ntp`コマンドを実行してNTPDをインストールしてください。
```
yum -y install ntp
```
NTPDはデフォルトでクライアントモードを使用します。

### NTPの設定
1. 次のコマンドを実行して、NTPサービスの構成ファイルを開きます。
```
vi /etc/ntp.conf
```
2. **i**キーを押して編集モードに切り替え、サーバーの関連設定を見つけます。以下に示すように、サーバーを、設定するターゲットNTPクロックソースサーバ（`time1.tencentyun.com`など）に変更し、不要なNTPクロックソースサーバを削除します。
![serverの設定](https://main.qcloudimg.com/raw/643dc5bbd2a42307ec10b5d38f756dda.png)
3. 「**Esc**」キーを押し、「**:wq**」を入力し、ファイルを保存して閉じます。

### NTPDの起動

次のコマンドを実行して、NTPDサービスを再起動します。
```
systemctl restart ntpd.service
```

### NTPDステータスの確認

次のコマンドを実行して、必要に応じて NTPDのステータスを確認します。 
- 次のコマンドを実行して、NTPがサービスポートUDP 123で正常にリッスンされているかどうかを確認します。
```
netstat -nupl
```
以下のような結果が返されると、正常にリッスンされていることを意味します。
![netstat -nupl](https://main.qcloudimg.com/raw/d7da764d05135959154920b81fa9f1e4.png)
- 次のコマンドを実行して、NTPDステータスが正常かどうかを確認します。
```
service ntpd status
```
以下のような結果が返されると、NTPDステータスが正常であることを意味します。
![ntpd status](https://main.qcloudimg.com/raw/321e56d0f7797f382d9f6903c0315f96.png)
次のコマンドを実行して、より詳細なNTPサービス情報を取得します。
```
ntpq -p
```
以下のような結果が返されます：
![](https://main.qcloudimg.com/raw/ca9ef4caf98b49ed2c9110198a66e7c3.png)
 - **remote**：このリクエストに応答するNTPサーバの名前。
 - **refid**：NTP サーバが使用する上位NTPサーバです。
 - **st**：リモートサーバーの階層。サーバーのストラタムは、1から16まで、高から低に設定できます。負荷やネットワークの輻輳を軽減するため、原則としてストラタム1サーバーへの直接接続は避けることが推奨されています。
 - **when**：最後に成功したリクエストから経過した秒数。
 - **poll**：ローカルサーバーとリモートサーバー間の同期間隔（秒単位）。NTPを最初に実行すると、pollの値が小さく、サーバと同期頻度が高いため、できるだけ早く正しい時間範囲に調整することをお勧めします。調整後、pollの値は徐々に増加し、同期頻度は減少します。
 - **reach**：サーバーに接続できるかどうかをテストするために使用される8進数。接続が成功するたびに、reachの値が増加します。
 - **delay**：ローカルマシンからNTPサーバーに同期要求を送信する往復時間。
 - **offset**：NTPを介してホストとタイムソース間のミリ秒（ms）単位の時間差。オフセットが0に近いほど、ホストとNTPサーバーの時間が近くなります。
 - **jitter**：統計に使用される値。特定の連続したコネクション数の場合のオフセットの分布を集計します。つまり、絶対値が小さいほど、ホスト時間は正確になります。

###  NTPD を自動起動に設定する

1. 次のコマンドを実行して、NTPDが起動時に自動的に起動するように設定します。
```
systemctl enable ntpd.service
```
2. 次のコマンドを実行して、chronyが起動時に自動的に起動するように設定されているかどうかを確認します。
```
systemctl is-enabled chronyd.service
```
chronyが起動時に自動的に起動するように設定されている場合は、次のコマンドを実行して、自動起動リストからchronyを削除します。
chronyがNTPDと競合しているため、 NTPD の起動に失敗する可能性があります。
```
systemctl disable chronyd.service
```

### NTPDセキュリティ強化

/etc/ntp.conf設定ファイルのセキュリティを強化するには、次のコマンドを順番に実行します。
```
interface ignore wildcard
```
```
interface listen eth0
```

## 概要
アクティブディレクトリAD（Active Directory）はMicrosoftサービスの主要なコンポーネントです。ADではユーザーの一括管理、アプリケーションのデプロイメント、 パッチの更新等の、効果的な管理を実現することができます。Microsoftの多くのコンポーネント（Exchange等）およびフェイルオーバークラスターにもADドメイン環境が必要です。この文書ではWindows Server 2012 R2 Datacenterエディション64ビットオペレーティングシステムを例にして、ADドメインの構築方法をご紹介します。

##  前提条件

- 2つのWindows Cloud Virtual Machine (CVM)インスタンスを作成し、ドメインコントローラ（DC）およびクライアント（Client）に割り当て済みであること。
- 作成したインスタンスが以下の条件を満たしていること：
	- NTFSパーティションにパーティション化されている。
	- インスタンスがDNSサービスをサポートしている。
	- インスタンスがTCP/IPプロトコルをサポートしている。

## インスタンスネットワーク環境
- グループネットワーク情報：ネットワークタイプはVirtual Private Cloud (VPC)を採用し、スイッチハブのプライベートネットワークセグメントは10.0.0.0/16です。
- ドメイン名情報：例示のインスタンスのドメイン名は`example.com`です。DCのCVMインスタンスのIPアドレスは10.0.5.102で、クライアントのCVMインスタンスのIPアドレスは10.0.5.97です。
<dx-alert infotype="notice" title="">
ADドメインの構築後、CVMインスタンスが常に同じIPアドレスを使用していることを確認してください。IPアドレスが変更されるとアクセスに異常が発生する可能性があります。
</dx-alert>



## 関連概念
アクティブディレクトリAD（Active Directory）はMicrosoftサービスの主要なコンポーネントです。関連用語の概念は以下のとおりです：
- **DC**：Domain Controllers。ドメインコントローラです。
- **DN**：Distinguished Name。識別名です。
- **OU**：Organizational Unit。組織単位です。
- **CN**：Canonical Name。正式名称です。
- **SID**：Security Identifier。セキュリティ識別子です。


## 操作手順

<dx-alert infotype="explain" title="">
既存のドメインコントローラを使用してカスタムイメージを作成し、新しいデプロイコントローラをデプロイメントすることは推奨されません。どうしても使用する必要がある場合は、新規作成したインスタンスのホスト名(hostname）とカスタムイメージ作成前のインスタンスのホスト名が一致していることを確認してください。一致していないと「サーバー上のセキュリティデータベースにこのワークステーションの信頼関係が存在しません」というエラーメッセージが表示されます。インスタンスを作成してから同じホスト名に変更すると、この問題が解決されます。
</dx-alert>



### ADドメインコントローラのデプロイ[](id:Step1)
1. DCにするインスタンスにログインします。詳細については、[標準方式を使用してWindowsインスタンスにログイン](https://intl.cloud.tencent.com/document/product/213/41018)をご参照ください。
2. オペレーティングシステムのインターフェースで、<img src="https://main.qcloudimg.com/raw/f779581f1ce3edfead8c725ce1504009.png" style="margin:-3px 0px">をクリックして、サーバーマネージャーを開きます。
3. **ロールと機能の追加**をクリックすると、「ロールと機能の追加ウィザード」ウィンドウがポップアップします。
4. 「インストールタイプの選択」インターフェースで、**ロールまたは機能に基づくインストール**を選択して、[次のステップ]を連続して2回クリックします。下図のとおりです。
![](https://qcloudimg.tencent-cloud.cn/raw/413f2376200fe7a64d56035206ac2c21.png)
5. 「サーバーロールの選択」インターフェースで、下図に示す「Active Directoryドメインサービス」および「DNSサーバー」にチェックを入れて、ポップアップ画面で**機能の追加**および**続ける**をクリックします。
この手順では、ADドメインサービスおよびDNSサービスデプロイが同じインスタンス上にある場合を例にしています。
![](https://qcloudimg.tencent-cloud.cn/raw/a9f62f646661dc1c3559b12328ed8077.png)
6. デフォルトの設定を維持したまま、**次へ**を4回続けてクリックします。
7. 情報の確認ページで、**インストール**をクリックします。
インストールの完了後、「ロールおよび機能の追加」ダイアログボックスを閉じます。
8. オペレーティングシステムのインターフェースで、<img src="https://main.qcloudimg.com/raw/f779581f1ce3edfead8c725ce1504009.png" style="margin:-3px 0px">をクリックして、サーバーマネージャーを開きます。
9. サーバーマネージャーのウィンドウで、<img src="https://main.qcloudimg.com/raw/b7b26ebdfecb3b158adac1a37d7a23f3.png" style="margin:-3px 0px">をクリックして、**このサーバーをドメインコントローラに変更する**を選択します。下図のとおりです。
![](https://qcloudimg.tencent-cloud.cn/raw/bc6e02bf64866c4458ec6599babe09a2.png)
10. 開いた「Active Directoryドメインサービスの設定ウィザード」画面で、「デプロイ操作の選択」設定を**フォレストの新規追加**にして、ルートドメイン名を入力し(この文書では「example.com」)、**次へ**をクリックします。下図のとおりです。
![](https://qcloudimg.tencent-cloud.cn/raw/b91884139c592c76cf3547fa7c5de711.png)
11. ディレクトリサービス復元モデル（DSRM）のパスワードを設定して、**次へ**をクリックします。下図のとおりです。
![](https://qcloudimg.tencent-cloud.cn/raw/192ba48444d9fef4faf46a2c5eb73983.png)
12. デフォルトの設定を維持したまま、**次へ**を4回続けてクリックします。
13. 「前提条件の検査中」で、**インストール**をクリックしてADドメインサーバーのインストールを開始します。
インストールが完了すると自動的にインスタンスが再起動し、インスタンスに再接続すると、**コントロールパネル** > **システムとセキュリティ** > **システム**にインストール結果が表示されます。下図のとおりです。
![](https://qcloudimg.tencent-cloud.cn/raw/32475970bbb3c6ff99a6ced08c3e72e1.png)

### クライアントSIDの変更
[SIDの変更操作の説明](https://intl.cloud.tencent.com/document/product/213/4829)をご参考の上、クライアントインスタンスにするSIDを変更してください。


### クライアントのADドメインへの追加
1. クライアントにするインスタンスにログインします。詳細については、[標準方式を使用してWindowsインスタンスにログイン](https://intl.cloud.tencent.com/document/product/213/41018)をご参照ください。
2. DNSサーバーアドレスを変更します。
  1. **コントロールパネル** > **ネットワークとインターネット** > **ネットワークと共有センター**の順に開いて、「ネットワークと共有センター」画面で**イーサネット**をクリックします。下図のとおりです。
![](https://qcloudimg.tencent-cloud.cn/raw/ecbcc37005bc2924ab9cb76055fd0666.png)
  2. 「イーサネットのステータス」画面で、**属性**をクリックします。
  3. 「イーサネットの属性」画面で「Internetプロトコルバージョン4（TCP/IPv4）」を選択して、**属性**をクリックします。
  4. 「Internetプロトコルバージョン4（TCP/IPv4）の属性」画面で、「以下のDNSサーバーアドレスを使用する」を選択して、最初に選択したDNSサーバーアドレスの設定をDCインスタンスのIPアドレスにします(ここでは`10.0.5.102`)。下図のとおりです。
    ![](https://qcloudimg.tencent-cloud.cn/raw/2201da4809892efa26558b3a99e6d324.png)
    [ADドメインコントローラのデプロイ](#Step1)でADドメインサービスとDNSサービスのデプロイが同じCVMインスタンス上（IPアドレスは10.0.5.102）に設定済みなので、ここではDNSサーバーのアドレスを10.0.5.102に指定します。
 5. **OK**をクリックして、変更を保存します。
3. cmdウィンドウで、以下のコマンドを実行して、PingがDNSサーバーのIPアドレスを通過できるかを確認します。
```
ping example.com
```
返された結果は下図のようになり、PingがDNSサーバーのIPアドレスを通過できることを示しています。
![](https://qcloudimg.tencent-cloud.cn/raw/cfd1ab27a7aaaeb42f9a78c67e476a53.png)
4. **コントロールパネル** > **システムとセキュリティ** > **システム**の順に開いて、「システム」画面で**設定の変更**をクリックします。下図のとおりです。
![](https://qcloudimg.tencent-cloud.cn/raw/6fb71866831646df81ed08c47e10843a.png)
5. 表示された「システムの属性」ウィンドウで、**変更**をクリックします。下図のとおりです。
![](https://qcloudimg.tencent-cloud.cn/raw/dbfe2df50797ee5fc07cb2ede72dc7ba.png)
6. 表示された「コンピュータ名/ドメインの変更」ウィンドウで、変更する必要があるコンピュータ名を押して、属する「ドメイン」を「example.com」に設定します。下図のとおりです。
![](https://qcloudimg.tencent-cloud.cn/raw/52b3f11a0347a93eb52d47069d3def1a.png)
7. **OK**をクリックします。
8. 表示される「Windowsセキュリティ」ウィンドウで、DCインスタンスのユーザー名を入力してパスワードを登録し、**OK**をクリックします。
下図のような確認画面が表示され、ドメインのログインが成功したことを示します。
![](https://qcloudimg.tencent-cloud.cn/raw/80856c8d02b87e6b00ef44df88941e89.png)
9. **OK**をクリックして、インスタンスを再起動して設定を有効にします。
<dx-alert infotype="explain" title="">
クライアントにするCVMインスタンスでは、ドメインにログイン済みのクライアントインスタンスを使用してカスタムイメージを作成しないようお勧めします。加入済みのものを使用すると、新規作成したイメージのインスタンスのせいで「サーバー上のセキュリティデータベースにこのワークステーションの信頼関係が存在しません」というエラーメッセージが表示されます。どうしても使用する必要がある場合は、新しいカスタムイメージを作成する前にドメインをログアウトすることをお勧めします。
</dx-alert>


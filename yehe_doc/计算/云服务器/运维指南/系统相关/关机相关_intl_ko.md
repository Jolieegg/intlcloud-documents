## CVM 종료(Shutdown) 프로세스 분석

### 종료 프로세스
>?[인스턴스 셧다운](https://intl.cloud.tencent.com/document/product/213/4929) 문서를 참조하여 작업하시기 바랍니다.
>
Tencent Cloud Windows 인스턴스의 종료 프로세스는 다음과 같습니다.
1. qmp 프로토콜을 통해 마스터 머신의 libvirt가 shutdown 명령어를 qemu 컴포넌트로 전달합니다.
2. qemu 컴포넌트가 acpi 인터럽트 모드를 통해 유입한 다음, shutdown 명령어를 CVM으로 전달합니다(상세 내용은 vmcs 관련 기술 문서를 참조 바랍니다).
3. Windows 인스턴스가 종료 신호를 받으면, 응용 프로그램과 서비스 프로세스의 종료를 알립니다.
4. 핵심 서비스 프로세스를 종료합니다.
5. 전원을 종료합니다.
>! 시스템 설정에 따라 3단계와 4단계에서 각 응용 프로그램과 서비스의 종료 순서가 다를 수 있습니다.

Windows는 하나의 클로즈드 소스 시스템으로, 커널 모드와 사용자 모드의 프로세스가 종료 과정에 관여할 수 있도록 API를 제공합니다. 한편, Windows 자체의 일부 서비스가 실행되는 과정에서 종료 프로세스에 영향을 주어 컴퓨터가 종료되지 않을 수 있습니다. 따라서, 상황에 따라 Windows의 종료 시간이 오래 걸릴 수 있습니다.

### 하드 셧다운
가상화 시나리오에서는 메시지를 통해 Windows 자체의 종료를 알리는 것 외에도 인스턴스를 중지하는 다른 방식도 제공합니다. 물리적 기기를 통한 전원 종료 방식과 유사한 방식으로, 이러한 종료 방식을 **하드 셧다운**이라고 합니다. 또한, 시스템 신호에 의해 발생하는 종료 작업을 상대적 의미로 **소프트 셧다운**이라 합니다.
하드 셧다운은 Windows 자체와 사용자 체험 모두에 영향을 미치며, 주로 다음의 두 가지 면에서 영향을 미칩니다.
1. 하드 셧다운은 일부 서비스와 응용 프로그램을 중단시킴으로써 저장되지 않은 문서, 완료되지 않은 WindowsUpdate 프로세스 등의 프로그램 작동을 비정상으로 만들 수 있습니다.
2. Windows NTFS 시스템(또는 초기 FAT32 등의 시스템)은 종료 프로세스 중 일부 주요 데이터를 입력합니다. 하드 셧다운은 이러한 주요 데이터가 디스크에 입력되지 않게 하여 Windows가 NTFS 파일 시스템이 손상되었다고 판단하게 만듭니다.

위와 같은 원인으로 Tencent Cloud 사용자는 **소프트 셧다운을 우선** 방식으로 사용하여 Windows 인스턴스를 종료할 것을 권장합니다.

## 종료 실패에 관한 여러 시나리오
Windows 시스템에 어떤 문제가 존재할 경우, 종료 프로세스에 영향을 미쳐 종료가 실패할 수 있습니다. 종료 실패에는 아래의 몇 가지 시나리오가 포함됩니다.
1. WindowsUpdate 프로세스로 인해 종료 시간이 연장될 수 있습니다. Windows는 패치 작업을 수행할 경우, 시스템이 종료되는 시간에 일부 프로세싱을 진행합니다. 이때 스크린에 일반적으로 '컴퓨터 전원을 종료하거나 전원 코드를 뽑지 마십시오.'라는 메시지가 표시됩니다.
2. 만약 Windows 시스템이 '종료 이벤트 추적' 메커니즘을 열어 시스템의 서비스 및 드라이버 프로그램에서 오류를 발견하고 종료할 경우, 시스템은 구성에 따라 사용자에게 대화 상자를 표시하거나 오류 설명을 작성하도록 하며, 사용자가 이러한 작업을 완료할 때까지 대기한 후 전원을 종료합니다. 사용자가 지정된 작업을 완료하기 전까지 Windows는 전원을 종료하지 않습니다.
3. Windows는 사용자가 시스템에 로그인하지 않은 경우, 종료를 허용하지 않도록 설정할 수 있습니다. 이러한 경우 가상화 호스트가 전송한 소프트 셧다운 명령은 Windows에 의해 버려지므로 종료할 수 없습니다.
4. Windows가 종료할 때 모든 서비스 및 응용 프로그램에 메시지가 전송됩니다. 만약 해당 프로그램들이 이러한 메시지를 받은 후에 종료 가능 응답을 리턴하지 않을 경우, 종료 프로세스는 진행되지 않습니다. 이와 같은 시나리오의 경우, Windows에서 일부 설정을 통해 해당 프로세스를 무시할 수 있습니다.
5. Windows가 전원 관리와 관련된 작업을 설정하는 중에 [전원을 누를 때 Windows의 처리 방식]을 무시하거나 작업하지 않도록 설정할 경우, Windows는 가상화 마스터 머신의 종료 이벤트를 무시하게 됩니다.
6. 전원 관리 설정으로 인해 Windows가 절전 상태로 진입할 경우, 종료 이벤트가 처리되지 않습니다.
7. Windows 시스템에 트로이 목마, 바이러스 등의 일부 악성 소프트웨어가 설치되어 Windows 시스템 환경 자체가 손상되었을 경우, Windows 종료가 차단될 수 있습니다.

Tencent Cloud는 Windows 공용 이미지를 배포할 때 소프트 셧다운이 원활하게 완료될 수 있도록 위에 서술된 대부분의 시나리오에 대해 최적화 작업을 했습니다. 그러나 이러한 최적화 조치에도 Windows에 트로이 목마 같은 바이러스의 공격 및 시스템 손상 등의 시나리오는 해결할 수 없습니다. 그 밖에 사용자의 Windows 인스턴스 관련 설정을 변경했을 때에도 소프트 셧다운의 원활한 진행을 보장할 수 없습니다.
**하드 셧다운은 리스크가 있으므로 꼭 필요한 경우에만 하드 셧다운 작업을 진행하길 권장합니다.**



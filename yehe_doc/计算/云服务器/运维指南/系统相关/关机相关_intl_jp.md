## CVMシャットダウンプロセス分析

### シャットダウンプロセス
> 関連する操作については、[インスタンスのシャットダウン](https://intl.cloud.tencent.com/document/product/213/4929)ドキュメントをご参照ください。
>
Tencent Cloud Windowsインスタンスのシャットダウンプロセスは下記の通り：
1. ホストのlibvirtはshutdownコマンドをqmpプロトコルを通してqemuコンポーネントに転送します。
2.qemuコンポーネントは、acpiを中断することによってシャットダウンコマンドをCVMに転送します（詳細については、vmcsに関連する技術ドキュメントをご覧ください）。
3. シャットダウン信号を受信した後、Windowsインスタンスはアプリケーションとサービスプロセスを終了します。
4. コアサービスプロセスを停止します。
5. 電源を切ります。
> その中、ステップ３とステップ４は、システム設定によって、各アプリケーションとサービスの停止順序が異なる可能性があります。

Windowsはクローズドソースシステムであり、いくつのAPIを提供することによってカーネルモードおよびユーザーモードのプログラムがシャットダウンプロセスに関与できるようにします。同時にWindows自体の一部実行中のサービスがシャットダウンプロセスに影響するため、コンピューターがシャットダウンできなくなります。そのため、Windowsのシャットダウンプロセスは時間がかかる場合があります。

### 強制シャットダウン
仮想化シナリオでは、メッセージ通知を利用してWindows自体をシャットダウンする以外、他のシャットダウン方法も提供しています。物理マシンの電源を切るのと類似方法であり、このシャットダウン方法を**強制シャットダウン**と呼びます。システム信号によって開始されるシャットダウン操作は、**ソフトシャットダウン**と呼ばれます。
強制シャットダウンは、次の2つの側面でWindowsとユーザーエクスペリエンスに影響を与える可能性があります。
1. 強制シャットダウンは、一部のサービスとアプリケーションを中断したため、これらのプログラムが正常に動作しない可能性があります。例えば、保存していないドキュメント、完了していないWindowsUpdateプロセスなど。
2. WindowsのNTFSシステム（または以前のFAT32などのシステム）はシャットダウンプロセス中にいくつかの重要なデータを書き込むため、 強制終了によってこれらの重要なデータがディスクに書き込めないと、WindowsがNTFSファイルシステムが破壊していると見なす可能性があります。

上記の理由に基づき、Tencent Cloudユーザーは**ソフトシャットダウンを利用**してWindows インスタンスをシャットダウンすることを推薦します。

##  コンピューターを正常にシャットダウンできない場合の原因
Windowsシステムにいくつかの問題があるため、シャットダウンプロセスが影響を受け、シャットダウンできない場合があります。
1. WindowsUpdateプロセスにより、シャットダウンにかかる時間が長くなる場合があります。 Windowsシステムは、シャットダウンプロセス中にパッチ操作を実行し、「コンピューターの電源を切ったり、電源コードのプラグを抜いたりしないでください」などのメッセージを表示する場合があります。　
2. Windowsシステムで「シャットダウンイベントトラッカー」メカニズムが有効になっていて、システムのサービスまたはドライバープログラムを実行するとエラーが発生してシャットダウンする必要がある場合、システムは設定によって、ユーザーにプロンプ​​トボックスを表示するか、エラーの説明を入力させて、ユーザーがこれらの操作を完了してから、電源を切ります。システムは、シャットダウンする前に、これらの操作が完了するのを待ちます。
3. Windowsはユーザーがシステムにログインしていない場合、シャットダウンを許可しないように設定します。この場合、仮想化ホストから送信されたソフトシャットダウンコマンドはWindowsによって破棄されるため、シャットダウンすることができません。
4. Windowsをシャットダウンする時、すべてのサービスとアプリケーションプにメッセージをブロードキャストします。これらのプログラムがこのメッセージを受信した後、肯定的な応答を返さない場合、シャットダウン処理は実行されません。この場合、Windowsは関連設定を行ってこの応答プロセスを無視します。
5. 電源管理の設定に関連する操作で、**パソコンの電源が落ちるときのWindowsの対処法**を無視するかまたは操作しないように設定する場合、Windows は仮想ホストのシャットダウンイベントを無視します。
6. Windowsは電源管理の設定によってスリープ状態になる時、シャットダウンイベントを処理しません。
7. Windowsシステムに悪意のあるソフトウェアをインストールした場合、又はトロイの木馬、ウイルスなどを感染した場合、Windowsシステム自体は破壊されたため、Windowsシャットダウンがブロックされる可能性があります。

Tencent CloudはWindowsパブリックイメージをリリースする際に、上記のほとんどのシナリオを最適化して、ソフトシャットダウンをスムーズに完了できるようになりました。ただし、これらの最適化対策では、Windowsがウイルス又はトロイの木馬を感染した場合やOSが破壊された場合などのシナリオを解決できません。また、ユーザーのWindowsインスタンスの関連設定を再度調整しても、ソフトシャットダウンがスムーズに実行することを保証できません。
**強制シャットダウンにはリスクがあるため、どうしても必要な場合のみ強制シャットダウンを実行することを推薦します。**







## Overview 

DevOps, a combination of development and operations, is becoming more and more popular among enterprises. It represents a culture that values the communication and collaboration between software developers (Dev) and IT Ops technicians (Ops). DevOps aims to make the process of software building, testing, and release faster, more frequent, and more reliable by automating the software delivery and architecture change processes. It can enable agile development in the cloud-native era. This document describes TKE DevOps for cloud native, where a seamless DevOps pipeline is established from the automatic image build triggered by code committing to the subsequent automatic deployment and update of applications in TKE clusters.  



## TKE DevOps 
### Overview 

TKE DevOps is an integration of [Tencent Kubernetes Engine (TKE)](https://intl.cloud.tencent.com/document/product/457), [Tencent Container Registry (TCR)](https://intl.cloud.tencent.com/document/product/1051/35480), and CODING DevOps. It's a one-stop cloud-native service featuring automated code compilation, container image build, image push, and application deployment for container use cases. For a quick start, see [TKE and CODING for Rapid Business Iteration](https://intl.cloud.tencent.com/document/product/457/38301).  



### Business process

TKE DevOps is a lifecycle management scheme that automates everything from code update to application deployment and update. Its business process is as shown below:
![process](https://qcloudimg.tencent-cloud.cn/raw/00b24d8903d89887afab9f49f6c0822c.png)


## Prerequisites

- You have created a TKE test cluster as instructed in [Quickly Creating a Standard Cluster](https://intl.cloud.tencent.com/document/product/457/40029).  
- You have activated the [TCR](https://intl.cloud.tencent.com/document/product/1051/35480) service, created accessible TCR test instances, and generated test instance access credentials. You need TCR Enterprise Standard Edition or Premium Edition to support cloud-native delivery workflows. For more information, see [Billing Overview](https://intl.cloud.tencent.com/document/product/1051/35483). For more information on the available regions of TCR, see [Billing Overview](https://intl.cloud.tencent.com/document/product/1051/35483).  
- You have activated the CODING DevOps service and built a well-established CODING DevOps team. If you are using a sub-account, you must have quickly created a sub-account with the operation permissions for the instance in the [CODING DevOps console](https://console.cloud.tencent.com/coding/container-devops) by using your root account, or have granted the sub-account such permissions as instructed in [Cloud Access Management](https://intl.cloud.tencent.com/document/product/598/32631).  
	
	
## Directions


TKE DevOps provides a powerful cloud-native DevOps service. This document describes how it automates the entire process from source code update to business release.  




### Accessing TKE DevOps 
Log in to the TKE console, click **[DevOps](https://console.cloud.tencent.com/coding/container-devops)** on the left sidebar, and click **Use Now** .


### Configuring code hosting[](id:step2)

Create a test project and test code repository on the CODING team homepage as instructed in [Creating Project and Code Repository](https://intl.cloud.tencent.com/document/product/457/38301#.E5.88.9B.E5.BB.BA.E9.A1.B9.E7.9B.AE.E5.B9.B6.E5.88.9B.E5.BB.BA.E4.BB.A3.E7.A0.81.E4.BB.93.E5.BA.93.3Cspan-id.3D.22createproduct.22.3E.3C.2Fspan.3E). For more information on CODING code hosting, see [Code Hosting](https://help.coding.net/docs/host/introduce.html).  

### Creating build plan
1. Log in to CODING DevOps and select **[Project](https://tencent-test.coding.net/user/projects)** on the left sidebar.  
2. On the **Project Management** page, click the name of the created [test project](#step2) to enter its details page.  
3. On the left sidebar, click **Continuous Integration** > **Build Plan** > **Create Build Plan** to enter the **Select Build Plan Template** page.  
>? A build plan is the basic unit of continuous integration and can be created quickly from a template. For more information, see [Continuous Integration Quick Start](https://help.coding.net/docs/ci/start.html).  
>
4. Select the **Build image and push it to TCR Enterprise Edition** template to quickly create a plan .
 Select the code source to be checked out and configure TCR access credential environment variables according to the build plan template. You can preview the generated Jenkinsfile on the right as shown below:
 >? CODING DevOps and TCR instances are connected and images are pushed over the private network by default, which requires no extra configuration.  
 > For a build project generated by using the template, you can customize its details by selecting the target project on the build plan details page and clicking **Set** on the project details page .

 - **Basic Info** allows you to select basic configuration items such as code source and node pool. For more information on node pools, see [Building Node](https://help.coding.net/docs/ci/node/overview.html).  
 - **Process Configuration** allows you to configure the environment for running build tasks. For more information, see [Building Environment](https://help.coding.net/docs/ci/ways.html).  
 - **Trigger Rule** allows you to configure trigger rules for a build plan that can be triggered in multiple ways. For more information, see [Trigger Rule](https://help.coding.net/docs/devops/ci/trigger.html).  
 - **Variables and Cache** list environment variables and cache configuration items. For more information, see [Environment Variables](https://help.coding.net/docs/ci/env.html) and [Cache Directories](https://help.coding.net/docs/ci/cache.html).  
 - **Notification** allows notifications to be sent to specific CODING team members when a build plan is completed.  
6. Click **OK**.  
7. (Optional) Click **Project Configuration** > **Developer Options** > **Webhook** > **Create Webhook** to push event notifications to WeCom and other instant messaging platforms as instructed in [Webhook](https://help.coding.net/docs/project/open/webhook.html) and [Binding WeCom Group Bot](https://help.coding.net/docs/project/open/wechat-robot.html). For more information on CODING continuous integration, see [Continuous Integration](https://help.coding.net/docs/ci/index.html).  



### Creating continuous deployment
1. Log in to CODING DevOps and select **[Project](https://tencent-test.coding.net/user/projects)** on the left sidebar.  
2. On the **Project Management** page, click the name of the created [test project](#step2) to enter its details page.  
3. On the left sidebar, select **Continuous Deployment** > **Kubernetes** and click **Configure Now**.
4. On the **Deployment Console** page, select the [cloud account to be configured](#one). Then, you can proceed to subsequent steps such as [configuring applications and processes](#two), [associating projects and applications](#three), and [starting deployment](#four).  

#### Configuring cloud account[](id:one)

Select a cloud account type as instructed in [Cloud Account](https://help.coding.net/docs/cd/cloudaccount.html). Configure the cloud account for accessing resources in the cloud. You can select a **TKE** or **Kubernetes** account. This document uses **Kubernetes** as an example to describe how to configure a cloud account.  
1. On the **Kubernetes-Based Continuous Deployment** page, click **Configure Now**.  
2. On the **Cloud Account Management** page, click **Bind Cloud Account** on the right.  
3. On the **Bind Cloud Account** page, select **Kubernetes** and other items as needed .
4. Click **OK**.  




#### Configuring application and process[](id:two)

For more information on CODING applications and projects, see [Applications and Projects](https://help.coding.net/docs/cd/app-project.html) and [Process Configuration](https://help.coding.net/docs/cd/pipe/overview.html). This document describes key configuration items to configure applications and processes.  
1. When creating an application, select **Kubernetes (TKE) Deployment** as the deployment method.
2. When you create a deployment process in the new application, select the **Kubernetes** process template and then select the template process as needed. Here, the **Deploy Deployment and Service to Kubernetes cluster** process is used as an example.
3. When you configure the deployment process in **Deployment Process**, associate the TCR image artifact generated in the previous continuous integration step under **Enable Required Artifact**.
4. On the **Automatic Trigger** page, bind the TCR image artifact. When a new version of an image is built successfully, the deployment process will be triggered automatically. The configuration method is.
5. The **Deployment** and **Service** are configured in a similar way, that is, adding a [cloud account](#one) with deployment permission and entering a custom **Manifest**, that is, the deployment YAML template.  
  This document describes how to manually configure TKE to pull access credentials for a TCR private repository image and customize the Deployment YAML. Below is a sample:
>! In the sample, a simple Deployment YAML is used for the Kubernetes cluster, along with the default `RollingUpdate` policy. In practice, you can leverage Nginx-ingress, Istio, and other tools to configure more advanced update policies, such as blue-green deployment, canary release, and A/B testing. For more information, see [Blue-Green Deployment](https://help.coding.net/docs/best-practices/cd/blue-green.html), [Nginx-ingress for Automated Grayscale Release](https://help.coding.net/docs/best-practices/cd/nginx-ingress.html), and [Continuous Deployment + TKE Mesh Grayscale Release Practice](https://help.coding.net/docs/best-practices/cd/tke-mesh.html).  
>
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: devops-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: devops-app
  template:
    metadata:
      labels:
        app: devops-app
    spec:
      containers:
        - image: xxx-test.tencentcloudcr.com/xxx-test/jokey-test  # Sample image address
          name: devops-app
          ports:
            - containerPort: 5000
      imagePullSecrets:  # Credential configuration for accessing the private repository 
        - name: tcr-secret # Access credential secret
```
Here, the image address field of `spec.template.spec.containers.*.image` is included in CODING's conversion matching rules, which are described in [Binding Artifact in Manifest](https://help.coding.net/docs/cd/pipe/artifacts/in-kubernetes.html#%E5%9C%A8-manifest-%E4%B8%AD%E7%BB%91%E5%AE%9A%E5%88%B6%E5%93%81).  
>? TKE pulls a TCR private repository image in two ways:
>- In the available regions of TCR, you can configure secret-free pulling of TCR container images by TKE. For more information on the available regions of TCR, see [Billing Overview](https://intl.cloud.tencent.com/document/product/1051/35483). For configuration directions, see [TKE Clusters Use the TCR Addon to Enable Secret-free Pulling of Container Images via Private Network](https://intl.cloud.tencent.com/document/product/1051/38386).  
>- Manually configure the TKE to pull access credentials of the TCR private repository image as instructed in [Sample TKE Configuration for Accessing Private Repository](https://help.coding.net/docs/cd/question/private-repo.html#Kubernetes-%E4%BA%91%E8%B4%A6%E5%8F%B7%EF%BC%88TKE-%E9%9B%86%E7%BE%A4%EF%BC%89).  
>
Below is a sample custom Service Manifest YAML:
```yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: devops-svc
  name: devops-svc
spec:
  ports:
    - port: 5000
      protocol: TCP
  selector:
    app: devops-app
```
6. (Optional) Configure custom event notifications for each deployment stage, so that you can be informed of the deployment process. This document describes the WeCom notification mode. For more information on how to get the Webhook URL of the WeCom bot, see [Creating WeCom Group Bot](https://help.coding.net/docs/project/open/wechat-robot.html#%E5%88%9B%E5%BB%BA%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E7%BE%A4%E6%9C%BA%E5%99%A8%E4%BA%BA).  

#### Associating project and application[](id:three)

For more information on associating projects and applications, see [Project and Application Association](https://help.coding.net/docs/cd/app-project.html#%E5%BA%94%E7%94%A8%E4%B8%8E%E9%A1%B9%E7%9B%AE%E5%85%B3%E8%81%94).  

#### Starting deployment[](id:four)
For release by a posting order and its configuration, see [Creating Posting Order](https://help.coding.net/docs/cd/app-project.html#%E6%96%B0%E5%BB%BA%E5%8F%91%E5%B8%83%E5%8D%95). For more information on CODING continuous deployment, see [Continuous Deployment](https://help.coding.net/docs/cd/overview.html).  



## Testing and Verification

In the project code file, add the v2 API code as shown below and commit the master branch:
![](https://main.qcloudimg.com/raw/edf184f16d1feaf6255a417947556242.png)
The build plan in **Continuous Integration** uses the **automatic execution upon code update** event trigger configuration. For more information on the trigger configuration, see [Trigger Rule](https://help.coding.net/docs/devops/ci/trigger.html). When the modified code is committed, the associated build plan will be automatically triggered.
If WeCom Webhook notifications are configured for continuous integration, WeCom will also receive the notifications.
When you generate a Docker image artifact in the build plan, the associated **continuous deployment** process will be triggered to update the new image application to the TKE cluster.
If the deployment process is configured with WeCom notifications, WeCom will be notified upon the deployment task completion.
At this point, you can see that the workload has been successfully updated in TKE as shown below:
![image-20201028214913813](https://main.qcloudimg.com/raw/6ab74e1d81f6c1f44c302ffbaeb1babc.png)
The test and verification results show that the entire DevOps process from source code update to business release is implemented in TKE.  
